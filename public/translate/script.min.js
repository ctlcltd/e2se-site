/*!
 * translate/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/translate",apipath="/api",sourcespath="/sources",routes={"":{"":main},"edit.html":{"":edit_translate},"add-language.html":{"":add_language}};function main(){console.log("main()");const v=document;v.title="E2SE Translations",v.description.setAttribute("content","Translation website for e2 SAT Editor");const e=v.getElementById("main"),y={locale:"Language",name:"Name",tr_name:"Translated name",completed:"Completed",revised:"Revised"},E=e.querySelector("table"),S=E.querySelector("thead"),A=E.querySelector("tbody");function T(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function _(e,t,n){if("completed"==t){if(!e._element){const r=v.createElement("span");r.className="level",r.title=n.toString()+"%",r.dataset.completed=n.toString(),r.style="--completed: "+n.toString()+"%;",e.append(r),e._element=r}}else"revised"==t?e.innerText=n?"yes":"none":n&&(e.innerText=n.toString())}v.getElementById("ctrbar-add-language").removeAttribute("hidden"),v.getElementById("ctrbar-submit-form").setAttribute("hidden",""),v.querySelector(".submit-form").classList.add("placeholder"),languages&&(E.hasAttribute("data-rendered")||(E.setAttribute("data-loading",""),function(e){const t=A.firstElementChild,n=A.querySelector("tr.placeholder");if(!S.hasAttribute("data-rendered")){for(const c in y){const u=v.createElement("th");u.innerText=y[c]??c,S.firstElementChild.insertBefore(u,S.firstElementChild.lastElementChild)}S.setAttribute("data-rendered","")}for(const m in e){var r=e[m].guid.toString(),a=e[m].code.toString(),o=e[m].type.toString(),i=e[m].dir.toString(),s=A.querySelector('[data-guid="'+r+'"]');const g=s||v.createElement("tr");for(const f in y)if(f in y){var l=e[m][f],d=Object.keys(y).indexOf(f),d=g.children.item(d);const p=d??v.createElement("td");p.hasAttribute("data-rendered")?f in e[m]&&_(p,f,l):(p._parent=g,_(p,f,l),p.setAttribute("data-rendered","")),d||g.append(p)}if(!s){if(n)for(const b of n.children)b!=n.firstElementChild&&g.append(b.cloneNode(!0));const h=g.querySelector("span.action-edit > a");h.href+="?lang="+a,g.setAttribute("data-guid",r),g.setAttribute("data-type",o),g.setAttribute("data-dir",i),g.setAttribute("data-href",h.href),g.setAttribute("data-animated",""),g.onclick=T,A.append(g)}}n&&n.remove(),t.remove(),E.removeAttribute("data-loading"),E.classList.remove("placeholder"),E.setAttribute("data-rendered","")}(languages)),function(){try{var e;for(const t in languages)if((e=localStorage.getItem(t))&&1<JSON.parse(e).length){v.getElementById("ctrbar-submit-form").removeAttribute("hidden"),v.querySelector(".submit-form").classList.remove("placeholder");break}}catch(e){console.error("allowSubmit",e)}}(),setTimeout(function(){!function(){for(var e=A.rows.length;e--;)A.rows.item(e).removeAttribute("data-animated"),A.rows.item(e).style="--delay: "+20*e+"ms;"}()},300)),e.removeAttribute("hidden")}function edit_translate(e,t,n){console.log("edit_translate()");const p=document;p.title="Edit - E2SE Translations",p.description.setAttribute("content","Edit translation strings of a language");const r=p.getElementById("page"),a=p.querySelector(".view-list"),o=a.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","edit-translate"),o.cloned=!0,r.insertBefore(o,a);const i=p.getElementById("edit-translate"),s=i.querySelector("h2"),f={ctx_name:"Node",msg_src:"Source",msg_tr:"Translation",disambigua:"Disambigua",notes:"Notes",msg_extra:"Comment",msg_comment:"Context",status:"Status"},h={0:"No translate",1:"Maybe wrong",2:"Maybe wrong",3:"Maybe wrong",6:"System string | Maybe wrong",8:"Conventional | Maybe wrong"},b=i.querySelector("table"),v=b.querySelector("thead"),y=b.querySelector("tbody");let E={};var l,d=n.split("=")[1];let S;const c=d+"-tr",u="tr-"+d;languages&&languages[d]&&(l=languages[d].code.toString(),n=languages[d].type.toString(),S=languages[d].dir.toString(),s.innerText="Edit "+languages[d].name,s.className="",b.setAttribute("data-lang",l),b.setAttribute("data-type",n),b.setAttribute("data-dir",S));let A=localStorage.getItem(u);try{A=A?JSON.parse(A):{}}catch(e){A={},console.error(e)}const m=source_request("src");function g(e){const t=e.target;if(t.hasAttribute("data-scroll-row")){e=t.getAttribute("data-scroll-row"),e=parseInt(e)-1;const n=y.rows.item(e);e=(n.previousElementSibling||n).offsetTop;scrollTo(0,e),n.classList.add("highlight"),setTimeout(function(){n.classList.remove("highlight")},2e3)}}function T(e){const t=e.target;t.classList.contains("toggler")?t.nextElementSibling.hasAttribute("hidden")?(t.nextElementSibling.removeAttribute("hidden"),t.classList.add("opened")):(t.nextElementSibling.setAttribute("hidden",""),t.classList.remove("opened"),setTimeout(function(){t.blur()},100)):p.querySelectorAll(".toggler").forEach(function(e){e.nextElementSibling.hasAttribute("hidden")||(e.nextElementSibling.setAttribute("hidden",""),e.classList.remove("opened"),setTimeout(function(){e.blur()},100))})}function _(e){const t=e.target;if(t.classList.contains("input")){e=t.parentElement.closest("[data-guid]");try{var n=e.dataset.guid;""!=t.srcText&&t.srcText===t.textContent?delete A[n]:A[n]=t.textContent,localStorage.setItem(u,JSON.stringify(A))}catch(e){console.error("textInput",e)}}}function x(e){1<A.length&&(p.getElementById("ctrbar-submit-form").removeAttribute("hidden"),p.querySelector(".submit-form").classList.remove("placeholder"))}function w(t,e,n){if("msg_tr"==e)if(t._element){var r=t._parent.dataset.guid;const a=t._element;A[r]?(a.srcText=n.toString(),a.innerText=A[r],a.dataset.changed=""):a.innerText=a.srcText=n.toString()}else{const o=p.createElement("span");o.className="input inline-edit",o.contentEditable="plaintext-only",o.dir=S,t.append(o),t._element=o}else if("disambigua"==e){if(!t._element&&n&&"object"==typeof n&&0!=Object.keys(n).length){const i=p.createElement("button");i.className="toggler",i.type="button",i.innerText=Object.keys(n).length;const s=p.createElement("ul"),l=p.createElement("div");l.className="dropdown",l.setAttribute("hidden",""),l.append(s),t.append(i),t.append(l),t._element=i;for(const d of n){const c=E[d],u=p.createElement("li"),m=p.createElement("a");m.href="javascript:",m.innerText=c.toString(),m.setAttribute("data-scroll-row",c),u.append(m),s.append(u)}}}else if("status"==e)if(t._element){const g=t._element;if(""!==n){let e;0==n?e="unfinished":1==n?e="completed":2==n&&(e="vanished"),g.className+=" status-"+e,g.innerText=e}}else{const f=p.createElement("span");f.className="status",t.append(f),t._element=f}else if("msg_extra"==e){if(n){let e=n.toString();e=e.replace(" | ","\n"),t.innerText=e.toString()}}else"notes"==e?n&&(n in h?t.innerText=h[n].replace(" | ","\n"):t.innerText=n.toString()):n&&(t.innerText=n.toString())}function L(e,t){try{var n=JSON.parse(e.response);if(!n.status)return;t&&function(e){if(0==Object.keys(E).length)for(const n in e){var t=e[n].guid;E[t]=n}}(n),function(e){const t=y.firstElementChild,n=y.querySelector("tr.placeholder");if(!v.hasAttribute("data-rendered")){for(const s in f){const l=p.createElement("th");l.innerText=f[s]??s,v.firstElementChild.insertBefore(l,v.firstElementChild.lastElementChild)}v.setAttribute("data-rendered","")}for(const d in e){var r=e[d].guid.toString(),a=y.querySelector('[data-guid="'+r+'"]');const c=a??p.createElement("tr");for(const u in f)if(u in f){var o=e[d][u],i=Object.keys(f).indexOf(u),i=c.children.item(i);const m=i??p.createElement("td");m.hasAttribute("data-rendered")?u in e[d]&&w(m,u,o):(m._parent=c,w(m,u,o),m.setAttribute("data-rendered","")),i||c.append(m)}if(!a){if(n)for(const g of n.children)c.append(g.cloneNode(!0));c.setAttribute("data-guid",r),c.title=parseInt(d)+1,y.append(c)}}n&&n.remove(),t.remove(),b.removeAttribute("data-loading"),b.classList.remove("placeholder")}(n),t||x()}catch(e){console.error("loader",e)}}function q(e){}p.getElementById("ctrbar-add-language").setAttribute("hidden",""),p.getElementById("ctrbar-submit-form").setAttribute("hidden",""),p.querySelector(".submit-form").classList.add("placeholder"),b.setAttribute("data-loading",""),m.then(function(e){L(e,!0);{const t=source_request(c);t.then(L).catch(q)}}).catch(q),y.addEventListener("click",T),y.addEventListener("click",g),y.addEventListener("input",_),y.addEventListener("blur",x),r.addEventListener("unload",function e(){y.removeEventListener("click",T),y.removeEventListener("click",g),y.removeEventListener("input",_),y.removeEventListener("blur",x),r.removeEventListener("unload",e)}),i.removeAttribute("hidden")}function add_language(e,t,n){console.log("add_language()");const s=document;s.title="Add language - E2SE Translations",s.description.setAttribute("content","Add a new language to translations");const r=s.getElementById("page"),a=s.querySelector(".view-edit"),o=a.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","add-language"),o.cloned=!0,r.insertBefore(o,a);const i=s.getElementById("add-language"),l=i.querySelector("h2"),d={lang_code:"ISO 639-1 language code (eg. xz)",lang_locale:"Locale language code (eg. xz_XA)",lang_dir:"Text directionality",lang_type:"Text type",lang_name:"Name",lang_tr_name:"Translated name",lang_numerus:"Numerus"},c={lang_code:{pattern:"[a-z]{2}",required:!0},lang_locale:{pattern:"[a-z]{2}_[A-Z]{2}",required:!0},lang_type:{type:"select",options:{1:"Type I (latin / ASCII)",2:"Type II (other alphabet)"},required:!0},lang_dir:{type:"select",options:{ltr:"LTR (Left To Right)",rtl:"RTL (Right To Left)"},required:!0},lang_name:{required:!0},lang_tr_name:{required:!0},lang_numerus:{type:"number"}};l.innerText="Add new language",l.className="";const u=i.querySelector("form"),m=u.firstElementChild;function g(e){let t={};for(const o of this.elements)"INPUT"!=o.nodeName&&"TEXTAREA"!=o.nodeName&&"SELECT"!=o.nodeName||""!=o.name&&(t[o.name]=o.value);var n=t.lang_code;let r=localStorage.getItem("languages");try{if(!r)throw"Storage Error";if(r=JSON.parse(r),n in r)throw"Language already exists"}catch(e){return void console.error("submit",e)}var a={guid:"",code:t.lang_code,locale:t.lang_locale,name:t.lang_name,tr_name:t.lang_tr_name,dir:t.lang_dir,type:0,numerus:parseInt(t.lang_numerus),completed:0,revised:0};try{r[n]=a,localStorage.setItem("languages",JSON.stringify(r)),route("")}catch(e){console.error("submit",e)}}function f(e){var t=this;if(e.preventDefault(),!t.hasAttribute("novalidate")&&"checkValidity"in t&&"function"==typeof t.checkValidity)!0===t.checkValidity()&&g.call(t,e);else{let n=!0;for(const a of t.elements)if("INPUT"==a.nodeName||"TEXTAREA"==a.nodeName||"SELECT"==a.nodeName){let e=!1,t="Required field";if(a.nextElementSibling&&a.nextElementSibling.classList.contains("novalid")&&a.nextElementSibling.remove(),a.hasAttribute("pattern")){var r=a.getAttribute("pattern");const o=new RegExp(r);a.hasAttribute("required")&&""==a?a.classList.add("novalid"):o&&!0===o.test(a.value)?(a.classList.remove("novalid"),e=!0):(a.classList.add("novalid"),t="No valid input")}else a.hasAttribute("required")?""!=a.value?(a.classList.remove("novalid"),e=!0):a.classList.add("novalid"):e=!0;if(!e){n=!1;const i=s.createElement("span");i.className="novalid",i.innerText=t,a.parentElement.append(i)}}n&&g.call(t,e)}}function p(e){var t=this;if(t.hasAttribute("novalidate")||!("checkValidity"in t)||"function"!=typeof t.checkValidity){e.preventDefault();for(const n of t.elements)"INPUT"!=n.nodeName&&"TEXTAREA"!=n.nodeName&&"SELECT"!=n.nodeName||(n.classList.remove("novalid"),n.nextElementSibling&&n.nextElementSibling.classList.contains("novalid")&&n.nextElementSibling.remove());t.reset()}}function h(e){const t=s.createElement("fieldset");for(const a in e){var n=e[a];const o=s.createElement("div");var r=function(e,t){const n=s.createElement("label");return n.innerText=t??e,n}(a,d[a]),n=function(e,t){let n;if(t){if("object"==typeof t){if("select"==t.type){n=s.createElement("select"),n.name=e;for(const r in t.options){const a=s.createElement("option");a.value=r,a.innerText=t.options[r],n.append(a)}}else"textarea"==t.type?(n=s.createElement("textarea"),n.name=e):(n=s.createElement("input"),n.name=e,n.setAttribute("type","text"));t.pattern&&n.setAttribute("pattern",t.pattern),t.required&&n.setAttribute("required","")}}else n=s.createElement("input"),n.setAttribute("type","text"),n.name=e;return n}(a,n);o.append(r),o.append(n),t.append(o),u.insertBefore(t,m)}u.classList.remove("placeholder"),u.addEventListener("submit",f),u.addEventListener("reset",p)}s.getElementById("ctrbar-add-language").setAttribute("hidden",""),s.getElementById("ctrbar-submit-form").setAttribute("hidden",""),s.querySelector(".submit-form").classList.add("placeholder"),h(c),r.addEventListener("unload",function e(){u.removeEventListener("submit",f),u.removeEventListener("reset",p),r.removeEventListener("unload",e)}),i.removeAttribute("hidden")}function styles(){var e=document.querySelectorAll(".what-this-area");if(e.length)for(const t of e)t.removeAttribute("hidden")}function token(){for(var e=10,n=[[48,57],[97,122],[65,90],[36,38,61,64]],r="";e--;){let e,t=Math.floor(4*Math.random());3==t&&100*Math.random()<50&&(t=parseInt(3*Math.random())),e=3==t?(e=Math.floor(Math.random()*n[t].length),n[t][e]):Math.floor(Math.random()*(n[t][1]-n[t][0]+1)+n[t][0]),r+=String.fromCharCode(e)}return r}function api_request(e,t,n,r){const a=new XMLHttpRequest;let o=apipath+"/";if("get"===e)o+=t?"?body="+t:"",o+=t&&n?"&call="+n:"",r&&(o+="&"+r,r=null);else{if("post"!==e)return new Promise(function(e,t){t("Request Error")});r="body="+t+n?"&call="+n:"&"+r}return a.open(e,o),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(r),new Promise(function(e,t){a.onload=function(){e(a)},a.onerror=function(){t(a)}})}function source_request(e){const n=new XMLHttpRequest;e="e2se-ts-"+e+".json",e=sourcespath+"/"+e;return n.open("get",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(),new Promise(function(e,t){n.onload=function(){e(n)},n.onerror=function(){t(n)}})}function route(e,t){const n=document.getElementById("page");var r=document.querySelectorAll("main"),a=!!e;if(e=e??window.location.href,t=t??document.title,-1===e.indexOf(basepath))throw"Wrong base path";const o=e.replace(window.location.protocol+"//"+window.location.host,""),i=o.split("?");var s=i[0].split("/")[2],e=(i[1]?i[1].split("&"):"")[0]??"";for(const l of r)l.cloned&&l.remove(),l.setAttribute("hidden","");if(null!=s&&s in routes==!1)throw"Wrong URI Route";if(""in routes[s]==!1)throw"Wrong QueryString Route";if("function"!=typeof routes[s][""])throw"No Function Route";r=new Event("unload");n.dispatchEvent(r),a&&window.history.pushState("",t,o),routes[s][""].call(this,s,"",e)}var languages;function init(){const n=document,r=n.body,t=source_request("langs");function a(e){try{var t=JSON.parse(e.response);if(!t.status)return;languages=t,route(),localStorage.setItem("languages",JSON.stringify(languages))}catch(e){console.error("loader",e)}}function o(e){}n.description=n.querySelector('meta[name="description"]'),function(){try{if(localStorage.getItem("_time")||localStorage.setItem("_time",(new Date).toJSON()),!localStorage.getItem("_time"))throw"Storage Error"}catch(e){console.error("requiredStorage",e);const t=n.createElement("div");t.className="message-box",t.innerHTML="<p><b>WebStorage is required</b></p><p>localStorage seems to be unavailable<br>Please reload your browser and try again</p>",r.append(t)}}(),function(){var e=localStorage.getItem("preferred-color");if("light"==e||"dark"==e){r.setAttribute("data-color",e),"dark"==e?r.classList.add("dark"):r.classList.remove("dark");const t=n.getElementById("switch-color");t.innerText="switch to "+("light"==e?"dark":"light")}}(),n.getElementById("head").addEventListener("click",function(e){const t=e.target;if("switch-color"==t.id){let e=r.hasAttribute("data-color")?r.getAttribute("data-color"):"light";"light"==e?(e="dark",t.innerText="switch to light",r.setAttribute("data-color","dark"),r.classList.add("dark"),setTimeout(function(){t.blur()},100)):"dark"==e&&(e="light",t.innerText="switch to dark",r.setAttribute("data-color","light"),r.classList.remove("dark"),setTimeout(function(){t.blur()},100)),"light"!=e&&"dark"!=e||localStorage.setItem("preferred-color",e)}}),window.addEventListener("popstate",function(e){route()}),function(){try{var e=localStorage.getItem("languages");e?(JSON.parse(e),languages=e,route()):t.then(a).catch(o)}catch(e){console.error("resume",e)}}()}styles(),window.token=token,init();})()