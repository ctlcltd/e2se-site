/*!
 * translate/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/translate",apipath="/api",sourcespath="/sources",routes={"":main,"edit.html":edit_translate,"add-language.html":add_language};function main(){console.log("main()");const v=document;v.title="Translations",v.description.setAttribute("content","Translation website for e2 SAT Editor");const e=v.getElementById("main"),y={locale:"Language",name:"Name",tr_name:"Translated name",completed:"Completed",revised:"Revised"},S=e.querySelector("table"),_=S.querySelector("thead"),E=S.querySelector("tbody");function A(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function k(e,t,n){if("completed"==t){if(!e._element){const r=v.createElement("span");r.className="level",r.title=n.toString()+"%",r.dataset.completed=n.toString(),r.style="--completed: "+n.toString()+"%;",e.append(r),e._element=r}}else"revised"==t?e.innerText=n?"yes":"none":n&&(e.innerText=n.toString())}v.getElementById("ctrbar-add-language").removeAttribute("hidden"),v.getElementById("ctrbar-submit-form").setAttribute("hidden",""),v.querySelector(".submit-form").classList.add("placeholder"),languages&&(S.hasAttribute("data-rendered")||(S.setAttribute("data-loading",""),function(e){const t=E.firstElementChild,n=E.querySelector("tr.placeholder");if(!_.hasAttribute("data-rendered")){for(const d in y){const u=v.createElement("th");u.innerText=y[d]??d,_.firstElementChild.insertBefore(u,_.firstElementChild.lastElementChild)}_.setAttribute("data-rendered","")}for(const m in e){var r=e[m].guid.toString(),a=e[m].code.toString(),o=e[m].type.toString(),s=e[m].dir.toString(),l=E.querySelector('[data-guid="'+r+'"]');const g=l||v.createElement("tr");for(const f in y)if(f in y){var i=e[m][f],c=Object.keys(y).indexOf(f),c=g.children.item(c);const p=c??v.createElement("td");p.hasAttribute("data-rendered")?f in e[m]&&k(p,f,i):(p._parent=g,k(p,f,i),p.setAttribute("data-rendered","")),c||g.append(p)}if(!l){if(n)for(const h of n.children)h!=n.firstElementChild&&g.append(h.cloneNode(!0));const b=g.querySelector("span.action-edit > a");b.href+="?lang="+a,g.setAttribute("data-guid",r),g.setAttribute("data-type",o),g.setAttribute("data-dir",s),g.setAttribute("data-href",b.href),g.setAttribute("data-animated",""),g.onclick=A,E.append(g)}}n&&n.remove(),t.remove(),S.removeAttribute("data-loading"),S.classList.remove("placeholder"),S.setAttribute("data-rendered","")}(languages)),function(){if(v.getElementById("ctrbar-submit-form").hasAttribute("hidden"))try{var e;for(const n in languages){var t="tr-"+n;if((e=localStorage.getItem(t))&&(e=JSON.parse(e),1<Object.keys(e).length)){v.getElementById("ctrbar-add-language").setAttribute("hidden",""),v.getElementById("ctrbar-submit-form").removeAttribute("hidden"),v.querySelector(".submit-form").classList.remove("placeholder");break}}}catch(e){console.error("allowSubmit",e)}}(),setTimeout(function(){!function(){for(var e=E.rows.length;e--;)E.rows.item(e).removeAttribute("data-animated"),E.rows.item(e).style="--delay: "+20*e+"ms;"}()},300)),e.removeAttribute("hidden")}function edit_translate(e,t){console.log("edit_translate()");const h=document,n=h.body;h.title="Edit - Translations",h.description.setAttribute("content","Edit translation strings of a language");const r=h.getElementById("page"),a=h.querySelector(".edit-translate"),o=a.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","edit-translate"),o._cloned=!0,r.insertBefore(o,a);const s=h.getElementById("edit-translate"),l=s.querySelector("h2"),v={ctx_name:"Node",msg_src:"Source",msg_tr:"Translation",disambigua:"Disambiguation",notes:"Notes",msg_extra:"Comment",msg_comment:"Context",status:"Status"},p={0:"No translate",1:"Maybe wrong",2:"Maybe wrong",3:"Maybe wrong",6:"System string | Maybe wrong",8:"Conventional | Maybe wrong"},y=s.querySelector("table"),S=y.querySelector("thead"),_=y.querySelector("tbody");let b={};var i,c=t.lang;let E,A;const d=c+"-tr",u="tr-"+c;languages&&languages[c]&&(i=languages[c].code.toString(),t=languages[c].type.toString(),E=languages[c].dir.toString(),A=!languages[c].guid,l.innerText="Edit "+languages[c].name,l.className="",y.setAttribute("data-lang",i),y.setAttribute("data-type",t),y.setAttribute("data-dir",E));let k=localStorage.getItem(u);try{k=k?JSON.parse(k):{}}catch(e){k={},console.error(e)}const m=source_request("src");function g(e){const t=e.target;if(t.hasAttribute("data-scroll-row")){e=t.getAttribute("data-scroll-row"),e=parseInt(e)-1;const n=_.rows.item(e);e=(n.previousElementSibling||n).offsetTop;scrollTo(0,e),n.classList.add("highlight"),setTimeout(function(){n.classList.remove("highlight")},2e3)}}function f(e){const r=e.target;if(r.classList.contains("sort")){const a=r.parentElement;let e=a.getAttribute("data-sort-column"),t=-1,n=0;e="1"!=e?(t=a.cellIndex,n=""==e?0:!parseInt(e),n?1:0):"";for(const o of S.rows[0].cells)o.setAttribute("data-sort-column","");a.setAttribute("data-sort-column",e),O(t,n);try{localStorage.setItem("_tristate",JSON.stringify([t,n]))}catch(e){console.error("sortByColumns",e)}}}function w(e){const t=e.target;t.classList.contains("toggler")?t.nextElementSibling.hasAttribute("hidden")?(t.nextElementSibling.removeAttribute("hidden"),t.classList.add("opened")):(t.nextElementSibling.setAttribute("hidden",""),t.classList.remove("opened"),setTimeout(function(){t.blur()},100)):h.querySelectorAll(".toggler").forEach(function(e){e.nextElementSibling.hasAttribute("hidden")||(e.nextElementSibling.setAttribute("hidden",""),e.classList.remove("opened"),setTimeout(function(){e.blur()},100))})}const x=debounce(function(e){const t=e.target;if(t.classList.contains("input")){e=t.parentElement.closest("[data-guid]");try{var n=e.dataset.guid;""!=t.srcText&&t.srcText===t.textContent?delete k[n]:k[n]=t.textContent,localStorage.setItem(u,JSON.stringify(k))}catch(e){console.error("textInput",e)}}},!1,50);function I(e){if(console.log("allowSubmit"),h.getElementById("ctrbar-submit-form").hasAttribute("hidden")&&1<Object.keys(k).length)h.getElementById("ctrbar-submit-form").removeAttribute("hidden"),h.querySelector(".submit-form").classList.remove("placeholder");else if(!e)try{var t;for(const r in languages){var n="tr-"+r;if((t=localStorage.getItem(n))&&(t=JSON.parse(t),1<Object.keys(t).length)){message("editprev");break}}}catch(e){console.error("allowSubmit",e)}}const T=debounce(I,!0);function N(e){300<window.pageYOffset?n.classList.add("ndm"):n.classList.remove("ndm")}const L=debounce(N,!1);function q(t,e,n){if("msg_tr"==e)if(t._element){if(n){var r=t._parent.dataset.guid;const a=t._element;k[r]?(a.srcText=n.toString(),a.innerText=k[r],a.dataset.changed=""):a.innerText=a.srcText=n.toString()}}else{const o=h.createElement("span");o.className="input inline-edit",o.contentEditable="plaintext-only",o.dir=E,t.append(o),t._element=o}else if("disambigua"==e){if(!t._element&&n){const s=h.createElement("button");s.className="toggler",s.type="button",s.innerText=Object.keys(n).length;const l=h.createElement("ul"),i=h.createElement("div");i.className="dropdown",i.setAttribute("hidden",""),i.append(l),t.append(s),t.append(i),t._element=s;for(const c of n){const d=b[c],u=h.createElement("li"),m=h.createElement("a");m.href="javascript:",m.innerText=d.toString(),m.setAttribute("data-scroll-row",d),u.append(m),l.append(u)}}}else if("status"==e)if(t._element){const g=t._element;let e;!n||0==n?e="unfinished":1==n?e="completed":2==n&&(e="vanished"),g.className+=" status-"+e,g.innerText=e}else{const f=h.createElement("span");f.className="status",t.append(f),t._element=f}else if("msg_extra"==e){if(n){let e=n.toString();e=e.replace(" | ","\n"),t.innerText=e.toString()}}else"notes"==e?n&&(A&&"0"==n||!A)&&(n in p?t.innerText=p[n].replace(" | ","\n"):t.innerText=n.toString()):n&&(t.innerText=n.toString())}function f(e){const r=e.target;if(r.classList.contains("sort")){const a=r.parentElement;let e=a.getAttribute("data-sort-column"),t=-1,n=0;e="1"!=e?(t=a.cellIndex,n=""==e?0:!parseInt(e),n?1:0):"";for(const o of S.rows[0].cells)o.setAttribute("data-sort-column","");a.setAttribute("data-sort-column",e),O(t,n);try{localStorage.setItem("_tristate",JSON.stringify([t,n]))}catch(e){console.error("sortByColumns",e)}}}function O(t,e){let n=[],r=[],a=0;if(-1!=t)for(const i of _.rows){n.push(i);let e=i.cells.item(t).textContent;e=isNaN(e)?e.trim().toLowerCase().replace("&",""):e?parseFloat(e):0,r.push([a++,e])}else for(const c of _.rows){n.push(c);var o=parseInt(c.title);r.push([a++,o])}var s,l;for(s=r,l=e,s.sort(function(e,t){return"string"==typeof e[1]&&"string"==typeof t[1]?l?t[1].localeCompare(e[1]):e[1].localeCompare(t[1]):l?t[1]-e[1]:e[1]-t[1]});_.firstChild;)_.removeChild(_.lastChild);for(const a in r)_.appendChild(n[r[a][0]])}function C(e){try{checker(e.status);var t=JSON.parse(e.response);!function(e){if(0==Object.keys(b).length)for(const n in e){var t=e[n].guid;b[t]=parseInt(n)}}(t),function(e){const t=_.firstElementChild,n=_.querySelector("tr.placeholder");if(!S.hasAttribute("data-rendered")){for(const l in v){const i=h.createElement("th");i.innerText=v[l]??l,S.firstElementChild.insertBefore(i,S.firstElementChild.lastElementChild)}S.setAttribute("data-rendered","")}if(!y.hasAttribute("data-sortable")){let e=0;for(const c in v){const d=S.rows[0].cells.item(e++),u=document.createElement("button");u.className="sort",u.innerText=v[c]??c,d.setAttribute("data-sort-column",""),d.innerText="",d.append(u)}y.setAttribute("data-sortable","")}for(const m in e){var r=e[m].guid.toString(),a=_.querySelector('[data-guid="'+r+'"]');const g=a??h.createElement("tr");for(const f in v)if(f in v){var o=e[m][f],s=Object.keys(v).indexOf(f),s=g.children.item(s);const p=s??h.createElement("td");p.hasAttribute("data-rendered")?"msg_tr"==f&&k[r]?q(p,f,k[r]):(f in e[m]||A)&&q(p,f,o):(p._parent=g,q(p,f,o),p.setAttribute("data-rendered","")),s||g.append(p)}if(!a){if(n)for(const b of n.children)g.append(b.cloneNode(!0));g.setAttribute("data-guid",r),g.title=parseInt(m),_.append(g)}}n&&n.remove(),t.remove(),y.removeAttribute("data-loading"),y.classList.remove("placeholder")}(t),function(){try{var n,r=localStorage.getItem("_tristate");let e=7,t=1;if(r&&(n=JSON.parse(r),e=n[0],t=n[1]),-1!=e&&S.rows[0].cells.item(e)){const o=S.rows[0].cells.item(e);var a=t?1:0;o.setAttribute("data-sort-column",a),O(e,t),r||localStorage.setItem("_tristate",JSON.stringify([e,t]))}}catch(e){console.error("resume_sort",e)}}()}catch(e){fault(e),console.error("loader",e)}}function B(e){message("reqerr"),console.warn(e)}h.getElementById("ctrbar-add-language").setAttribute("hidden",""),h.getElementById("ctrbar-submit-form").setAttribute("hidden",""),h.querySelector(".submit-form").classList.add("placeholder"),y.setAttribute("data-loading",""),m.then(function(e){if(C(e),A)C(e);else{const t=source_request(d);t.then(C).catch(B)}N(),I()}).catch(B),_.addEventListener("click",w),_.addEventListener("click",g),_.addEventListener("input",x),_.addEventListener("input",T),S.addEventListener("click",f),window.addEventListener("scroll",L),r.addEventListener("unload",function e(){n.classList.remove("dnm"),_.removeEventListener("click",w),_.removeEventListener("click",g),_.removeEventListener("input",x),_.removeEventListener("input",T),S.addEventListener("click",f),window.removeEventListener("scroll",L),r.removeEventListener("unload",e)}),s.removeAttribute("hidden")}function add_language(e,t){console.log("add_language()");const i=document;i.title="Add language - Translations",i.description.setAttribute("content","Add a new language to translations");const n=i.getElementById("page"),r=i.querySelector(".add-language"),a=r.cloneNode(!0);a.removeAttribute("class"),a.setAttribute("id","add-language"),a._cloned=!0,n.insertBefore(a,r);const o=i.getElementById("add-language"),s=o.querySelector("h2"),l={lang_code:"ISO 639-1 language code (eg. xz)",lang_locale:"Locale language code (eg. xz_XA)",lang_dir:"Text directionality",lang_type:"Text type",lang_name:"Name",lang_tr_name:"Translated name",lang_numerus:"Numerus"},c={lang_code:{pattern:"[a-z]{2}",required:!0},lang_locale:{pattern:"[a-z]{2}_[A-Z]{2}",required:!0},lang_type:{type:"select",options:{1:"Type I (latin / ASCII)",2:"Type II (other alphabet)"},required:!0},lang_dir:{type:"select",options:{ltr:"LTR (Left To Right)",rtl:"RTL (Right To Left)"},required:!0},lang_name:{required:!0},lang_tr_name:{required:!0},lang_numerus:{type:"number",min:1,max:8,default:1}};s.innerText="Add new language",s.className="";const d=o.querySelector("form");function u(e){var t=this;let r;if(e.preventDefault(),!t.hasAttribute("novalidate")&&"checkValidity"in t&&"function"==typeof t.checkValidity)r=t.checkValidity();else for(const o of t.elements)if("INPUT"==o.nodeName||"TEXTAREA"==o.nodeName||"SELECT"==o.nodeName){let e=!1,t="Required field";o.nextElementSibling&&o.nextElementSibling.classList.contains("novalid")&&o.nextElementSibling.remove();var a=o.getAttribute("type");let n;if(o.hasAttribute("pattern")?n=o.getAttribute("pattern"):"INPUT"!=o.nodeName||"number"!=a&&"range"!=a||(n="^[0-9]$"),n&&""!=o.value){const s=new RegExp(n);s&&!0===s.test(o.value)?e=!0:t="No valid input"}else e=(o.hasAttribute("required")&&o.value,!0);if(e)o.classList.remove("novalid"),r=!0;else{o.classList.add("novalid"),r=!1;const l=i.createElement("span");l.className="novalid",l.innerText=t,o.parentElement.append(l)}}r&&!function(e){const t=this;let n={};for(const s of t.elements)"INPUT"!=s.nodeName&&"TEXTAREA"!=s.nodeName&&"SELECT"!=s.nodeName||""!=s.name&&(n[s.name]=s.value);var r=n.lang_code;let a=localStorage.getItem("languages");try{if(!a)throw except(2);if(a=JSON.parse(a),r in a)throw message("langexists"),except(13)}catch(e){return void console.error("submit",e)}var o={guid:"",code:n.lang_code,locale:n.lang_locale,name:n.lang_name,tr_name:n.lang_tr_name,dir:n.lang_dir,type:0,numerus:parseInt(n.lang_numerus),completed:0,revised:0};try{a[r]=o,localStorage.setItem("languages",JSON.stringify(a)),t.setAttribute("data-loading",""),setTimeout(function(){t.removeAttribute("data-loading"),route(basepath+"/")},300)}catch(e){console.error("submit",e)}}.call(t,e)}function m(e){var t=this;let n;!t.hasAttribute("novalidate")&&"checkValidity"in t&&"function"==typeof t.checkValidity?n=!1:(e.preventDefault(),n=!0,t.reset());for(const r of t.elements)"INPUT"!=r.nodeName&&"TEXTAREA"!=r.nodeName&&"SELECT"!=r.nodeName||(n&&(r.classList.remove("novalid"),r.nextElementSibling&&r.nextElementSibling.classList.contains("novalid")&&r.nextElementSibling.remove()),r._value&&r.setAttribute("value",r._value))}function g(e){const t=i.createElement("fieldset");for(const a in e){var n=e[a];const o=i.createElement("div");var r=function(e,t){const n=i.createElement("label");return n.innerText=t??e,n}(a,l[a]),n=function(e,t,n){let r;if(t){if("object"==typeof t){if("select"==t.type){r=i.createElement("select"),r.name=e;for(const a in t.options){const o=i.createElement("option");o.value=a,o.innerText=t.options[a],r.append(o)}}else"textarea"==t.type?(r=i.createElement("textarea"),r.name=e):(r=i.createElement("input"),r.name=e,r.setAttribute("type",t.type),t.min&&r.setAttribute("min",parseInt(t.min)),t.max&&r.setAttribute("max",parseInt(t.max)),t.step&&r.setAttribute("step",parseInt(t.step)));t.placeholder&&r.setAttribute("placeholder",t.placeholder),t.pattern&&r.setAttribute("pattern",t.pattern),t.required&&r.setAttribute("required",""),t.readonly&&r.setAttribute("readonly",""),n?r.value=r._value=n:t.default&&(r.value=r._value=t.default),r._value&&"select"!=t.type&&"textarea"!=t.type&&r.setAttribute("value",r._value)}}else r=i.createElement("input"),r.setAttribute("type","text"),r.name=e;return r}(a,n);o.append(r),o.append(n),t.append(o),d.insertBefore(t,d.firstElementChild)}d.classList.remove("placeholder"),d.addEventListener("submit",u),d.addEventListener("reset",m)}i.getElementById("ctrbar-add-language").setAttribute("hidden",""),i.getElementById("ctrbar-submit-form").setAttribute("hidden",""),i.querySelector(".submit-form").classList.add("placeholder"),g(c),function(e){console.log("allowSubmit");try{var t;for(const r in languages){var n="tr-"+r;if((t=localStorage.getItem(n))&&(t=JSON.parse(t),1<Object.keys(t).length)){message("editprev");break}}}catch(e){console.error("allowSubmit",e)}}(),n.addEventListener("unload",function e(){d.removeEventListener("submit",u),d.removeEventListener("reset",m),n.removeEventListener("unload",e)}),o.removeAttribute("hidden")}function send_translation(){console.log("send_translation()");const o=document,a=o.getElementById("page");let g;function s(e){e.preventDefault();try{let e,t,n,r;var o;for(const u in languages){var s="tr-"+u,l=languages[u];if((o=localStorage.getItem(s))&&(o=JSON.parse(o),1<Object.keys(o).length)){e=o,t=u,n=l.guid;break}}for(const m in languages){var i=languages[m];if(!i.guid){i.code===t?r=i:e=null;break}}if(!e)throw except(10);let a={};if(r)a.language=r;else{if(!n)throw except(8);a.lang=n}a.translation=e;var c=g.querySelector('[name="send_user"]');c.value&&(a.user=c.value);const d=api_request("post","userland","submit",{token:get_token(),data:a});g.setAttribute("data-loading",""),d.then(f).catch(p)}catch(e){console.error("submit",e)}}function l(e){e=e.target;"BUTTON"==e.nodeName&&"button"==e.type&&(send_unlock(),route(basepath+"/"))}function f(e){g.removeAttribute("data-loading");try{checker(e.status);var t=JSON.parse(e.response);if(checker(t.status),!t.data)throw except(1);var n=t.data;if(!(n&&n.token&&validate_token(n.token)))throw except(1);reset_data(!1),localStorage.setItem("_token",1),localStorage.setItem("token",n.token),message("token","",1)}catch(e){g.removeAttribute("data-loading"),fault(e),console.error("sent",e)}send_unlock(),route(basepath+"/")}function p(e){console.warn(e),g.removeAttribute("data-loading"),message("reqerr"),send_unlock()}function i(){g.removeEventListener("submit",s),a.removeEventListener("unload",i)}!function(e){try{var t;for(const r in languages){var n="tr-"+r;if((t=localStorage.getItem(n))&&(t=JSON.parse(t),1<Object.keys(t).length)){!function(){(function(){var e=o.querySelectorAll("main");for(const t of e)t._cloned&&t.remove(),t.setAttribute("hidden","");window.scrollTo(window.scrollX,0)})(),o.title="Send translation - Translations",o.description.setAttribute("content","Send translation strings");const e=o.querySelector(".send-translation"),t=e.cloneNode(!0);t.removeAttribute("class"),t.setAttribute("id","send-translation"),t._cloned=!0,a.insertBefore(t,e);const n=o.getElementById("send-translation"),r=n.querySelector("h2");r.innerText="Send translation",r.className="",g=n.querySelector("form"),o.getElementById("ctrbar-add-language").setAttribute("hidden",""),o.getElementById("ctrbar-submit-form").setAttribute("hidden",""),o.querySelector(".submit-form").classList.add("placeholder"),function(){const e=o.createElement("fieldset"),t=o.createElement("div"),n=document.createElement("label"),r=document.createElement("input"),a=document.createElement("span");n.innerText="User name",r.name="send_user",r.setAttribute("type","text"),a.className+="describe",a.innerHTML="<p>You could add your name or acronym before submit.</p><p><em>Please do not enter sensitive informations.</em></p>",t.append(n),t.append(r),t.append(a),e.append(t),g.insertBefore(e,g.firstElementChild),g.classList.remove("placeholder"),g.addEventListener("submit",s),g.addEventListener("click",l)}(),a.addEventListener("unload",i),n.removeAttribute("hidden"),send_lock()}();break}}}catch(e){console.error("allowSubmit",e)}}()}function form_submit(){const e=document.querySelector(".submit-form");e.addEventListener("click",function(e){"BUTTON"==(e=e.target).nodeName&&"button"==e.type&&send_translation()})}function send_lock(){try{localStorage.setItem("_lock","send")}catch(e){console.error("send_lock",e)}}function send_unlock(){try{localStorage.removeItem("_lock")}catch(e){console.error("send_unlock",e)}}function send_resume(){try{"send"==localStorage.getItem("_lock")&&window.addEventListener("load",send_translation)}catch(e){console.error("send_resume",e)}}function get_token(){for(var e=10,n=[[48,57],[97,122],[65,90],[36,38,61,64]],r="";e--;){let e,t=Math.floor(4*Math.random());3==t&&100*Math.random()<50&&(t=parseInt(3*Math.random())),e=3==t?(e=Math.floor(Math.random()*n[t].length),n[t][e]):Math.floor(Math.random()*(n[t][1]-n[t][0]+1)+n[t][0]),r+=String.fromCharCode(e)}return r}function resume_translation(s){const e=document,i=e.getElementById("page");e.getElementById("token");function l(e){i.removeAttribute("data-loading");try{checker(e.status);var n=JSON.parse(e.response);checker(n.status);let t=!1;if(!n.data)throw except(1);{var r=n.data;let e;if(r.ulang){var a=r.ulang;e=a.code,languages[e]=a,localStorage.setItem("languages",JSON.stringify(languages)),t=!0}else if(r.lang)for(const l in languages)if(languages[l].guid===r.lang){e=l;break}if(!(e&&r.data&&r.data.utr))throw except(1);var o=r.data.utr,s="tr-"+e;localStorage.setItem(s,JSON.stringify(o)),t=!0}t&&message("resumed")}catch(e){i.removeAttribute("data-loading"),fault(e),console.error("loader",e)}}function c(e){console.warn(e),i.removeAttribute("data-loading"),message("reqerr")}if(!validate_token(s))throw except(12);!function(){try{let e=!0;var t;for(const r in languages){var n="tr-"+r;if((t=localStorage.getItem(n))&&(t=JSON.parse(t),1<Object.keys(t).length)){e=!1;break}}for(const a in languages)if(!languages[a].guid){e=!1;break}if(e){const o=api_request("post","userland","resume",{token:s});i.setAttribute("data-loading",""),o.then(l).catch(c)}else localStorage.setItem("_resume",s),localStorage.setItem("_lock","resume"),message("editprev")}catch(e){console.error("allowResume",e)}}()}function form_token(){const e=document,t=e.querySelector(".token-form"),n=t.querySelector("#token");function r(e){e.target===t&&e.preventDefault();e=n.value;10===e.length&&validate_token(e)&&(n.setAttribute("disabled",""),resume_translation(e),n.removeAttribute("disabled"))}var a=debounce(r,!1,50);n.addEventListener("input",a),t.addEventListener("submit",r)}function your_token(){try{localStorage.getItem("_token")&&message("token")}catch(e){console.error("your_token",e)}}function token_box_html(t){try{var n=localStorage.getItem("token");if(!validate_token(n))throw except(12);let e=1==t?"<p><b>Thank you for contribution</b></p>":"";return e+="<div>",e+="<p>Please take a note of your token</p>",e+="<p>This is useful to resume the translation you have sent</p>",e+="</div>",e+='<div><input type="text" id="your-token" value="'+n+'" readonly></div>',e}catch(e){console.error("token_box_html",e)}}function token_box_dismiss(){try{localStorage.removeItem("_token")}catch(e){console.error("token_box_dismiss",e)}}function validate_token(e){return/[a-zA-Z0-9$&=@]{10}/g.test(e)}function message(t,e,n,r){const a=document,o=a.createElement("div");function s(){a.body.classList.remove("backdrop"),msg=null,setTimeout(function(){o.remove()},150)}if(t){let e;if("storage"==t)e="<p><b>WebStorage is required</b></p><p>localStorage seems to be unavailable</p><p>Please reload your browser and try again</p>";else if("langexists"==t)e="<p>Language already exists</p>",n=0;else if("reqerr"==t)e="<p><b>An error occurred<b></p><p>Please try again</p>",n=0;else if("editprev"==t)e="<p>You have a previous translation edit that was not sent</p><p><b>Do you want to SUBMIT or DISCARD the previous edit?</b></p>",n=2,r=[{label:"Submit",class:"primary",callback:send_translation},{label:"Discard",class:"secondary tiny",callback:discard_edit},{label:"Cancel",class:"tiny",callback:s}];else if("token"==t){if(e=token_box_html(n),!e)return message("error");n=1,r=[{label:"Dismiss",class:"secondary tiny",callback:token_box_dismiss}]}else"reset"==t?(e="<p>RESET DATA</p><p>This will re-initialize data</p><p><b>Do you want to RESET all data?</b></p>",n=2,r=[{label:"Reset",class:"primary",callback:reset_data},{label:"Cancel",class:"tiny",callback:s}]):"cleared"==t?(e="<p><b>Session cleared!<b></p>",n=1):"resumed"==t?(e="<p><b>Session resumed!<b></p>",n=1):"busy"==t?(e="<p><b>Service is busy</b></p><p>You have reach the send limit quota</p><p>Please wait few seconds and try again</p>",n=0):"error"==t&&(e="<p><b>An error occurred<b></p>",n=0);o.innerHTML=e}else{if(!e)return;o.innerText=e}if(o.className="message-box",0===n?o.className+=" error":1===n?o.className+=" success":2===n&&(o.className+=" ask"),null!=n&&(a.body.classList.add("backdrop"),o.className+=" top",r=r||[{label:"OK",class:"secondary tiny",callback:s}]),r&&"object"==typeof r){const l=a.createElement("div");l.className="feedback";for(const i of r){const c=a.createElement("button");i.class&&(c.className+=i.class),c.innerText=i.label,i.callback&&"function"==typeof i.callback&&(c.onclick=function(e){s(),i.callback.call(this,e)}),l.append(c)}o.append(l)}msg?msg.replaceWith(o):a.body.append(o),msg=o}function fault(e){switch(e){case 429:case 503:message("busy");break;default:message("error")}}function except(e){switch(e){case 1:return"An error occurred";case 2:return"Storage Error";case 3:return"Wrong base path";case 4:return"Wrong URI Route";case 6:return"No Function Route";case 8:return"Not a valid submit";case 10:return"Not a valid translation submit";case 12:return"Not a valid token";case 13:return"Language already exists"}}function checker(e){if(!e)throw except(1);if(399<e)throw e}function what_this(){var e=document.querySelectorAll(".what-this-area");if(e.length)for(const t of e)t.removeAttribute("hidden")}function discard_edit(){try{for(const t in languages){var e="tr-"+t;localStorage.getItem(e)&&localStorage.removeItem(e)}"resume"==localStorage.getItem("_lock")&&(resume_translation(localStorage.getItem("_resume")),localStorage.removeItem("_lock"),localStorage.removeItem("_resume"))}catch(e){console.error("discard_edit",e)}}function reset_data(e){const t=source_request("langs");try{var n=localStorage.getItem("preferred-color");localStorage.clear(),localStorage.setItem("_time",(new Date).toJSON()),"light"!=n&&"dark"!=n||localStorage.setItem("preferred-color",n),t.then(function(e){try{checker(e.status);var t=JSON.parse(e.response);languages=t,localStorage.setItem("languages",JSON.stringify(languages))}catch(e){fault(e),console.error("done",e)}}).catch(function(e){message("reqerr"),console.warn(e)}),!1!==e&&(message("cleared"),route(basepath+"/"))}catch(e){console.error("reset_data",e)}}function debounce(t,e,n){n=n??300;let r;return e?function(){r||t.apply(this,arguments),clearTimeout(r),r=setTimeout(function(){r=void 0},n)}:function(){const e=arguments;clearTimeout(r),r=setTimeout(function(){t.apply(this,e)},n)}}function api_request(e,t,n,r){const a=new XMLHttpRequest;let o=apipath+"/",s=null;function l(t){var n=[];try{for(const r of Object.keys(t)){let e=t[r];"object"==typeof e&&(e=JSON.stringify(e)),e=encodeURIComponent(e.toString()),n.push(r+"="+e)}}catch(e){console.error(e)}return n.join("&")}if("get"===e)t&&(o+="?body="+t),n&&(o+=t?"&":"?&call="+n),r&&"object"==typeof r&&(o+=t||n?"&":"?"+l(r));else{if("post"!==e)return new Promise(function(e,t){t("Request Error")});s="body="+t,n&&(s+="&call="+n),r&&"object"==typeof r&&(s+="&"+l(r))}return a.open(e,o),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(s),new Promise(function(e,t){a.onload=function(){e(a)},a.onerror=function(){t(a)}})}function source_request(e){const n=new XMLHttpRequest;e="e2se-ts-"+e+".json",e=sourcespath+"/"+e;return n.open("get",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(),new Promise(function(e,t){n.onload=function(){e(n)},n.onerror=function(){t(n)}})}function route(e,t){const n=document.getElementById("page");var r=document.querySelectorAll("main"),a=!!e;if(e=e??window.location.href,t=t??document.title,-1===e.indexOf(basepath))throw except(3);const o=e.replace(window.location.protocol+"//"+window.location.host,""),s=o.split("?");var l=s[0].split("/")[2],e=s[1]?s[1].split("&"):"";let i={};if(e)for(var c of e)c=c.split("="),i[c[0]]=c[1];console.info("route",{qs:e,uri:l,search:i});for(const d of r)d._cloned&&d.remove(),d.setAttribute("hidden","");if(null!=l&&l in routes==!1)throw except(4);if("function"!=typeof routes[l])throw except(6);r=new Event("unload");n.dispatchEvent(r),a&&window.history.pushState("",t,o),routes[l].call(this,l,i),a&&window.scrollTo(window.scrollX,0)}var languages,msg;function init(){const n=document,r=n.body,a=source_request("langs");function o(){try{"send"!=localStorage.getItem("_lock")&&(route(),localStorage.removeItem("_lock")),your_token(),form_token()}catch(e){console.error("view",e),route()}}function s(e){try{checker(e.status);var t=JSON.parse(e.response);languages=t,o(),localStorage.setItem("languages",JSON.stringify(languages))}catch(e){fault(e),console.error("loader",e)}}function l(e){message("reqerr"),console.warn(e)}n.description=n.querySelector('meta[name="description"]'),function(){try{if(localStorage.getItem("_time")||localStorage.setItem("_time",(new Date).toJSON()),!localStorage.getItem("_time"))throw except(2)}catch(e){console.error("requiredStorage",e),message("storage")}}(),function(){var e=localStorage.getItem("preferred-color");if("light"==e||"dark"==e){r.setAttribute("data-color",e),"dark"==e?r.classList.add("dark"):r.classList.remove("dark");const t=n.getElementById("switch-color");t.innerText="switch to "+("light"==e?"dark":"light")}}(),n.getElementById("head").addEventListener("click",function(e){const t=e.target;var n;"switch-color"==t.id&&("light"!=(n=r.hasAttribute("data-color")?r.getAttribute("data-color"):"light")&&"dark"!=n||(e="light"==n?"dark":"light",t.innerText="switch to "+n,r.setAttribute("data-color",e),"light"==n?r.classList.add("dark"):r.classList.remove("dark"),setTimeout(function(){t.blur()},100),localStorage.setItem("preferred-color",e)))}),window.addEventListener("popstate",function(e){route()}),function(){try{var e,t=localStorage.getItem("languages");t?(e=JSON.parse(t),languages=e,o()):a.then(s).catch(l)}catch(e){message("error"),console.error("resume",e)}}(),function(){const e=n.getElementById("reset");e.addEventListener("click",function(e){message("reset")})}()}form_submit(),send_resume(),what_this(),init();})()