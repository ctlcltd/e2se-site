/*!
 * translate/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/translate",apipath="/api",sourcespath="/sources",routes={"":{"":main},"edit.html":{"":edit_translate},"add-language.html":{"":add_language}};function main(){const e=document.getElementById("main"),h={iso:"Language",name:"Name",tr_name:"Translated name",completed:"Completed",revised:"Revised"},b=e.querySelector("table"),y=b.querySelector("thead"),v=b.querySelector("tbody");function S(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function _(e,t,n){e.innerText=n?n.toString():"",n&&"completed"==t?(e.style="color: gray;",e.innerHTML=e.innerText+'% <abbr style="border-bottom: 1px dotted">?</abbr>'):n&&"revised"==t&&(e.innerText=n?"yes":"none")}!b.hasAttribute("data-rendered")&&languages&&(b.setAttribute("data-loading",""),function(e){const t=v.firstElementChild,n=v.querySelector("tr.placeholder");if(!y.hasAttribute("data-rendered")){for(const l in h){const c=document.createElement("th");c.innerText=h[l]??l,y.firstElementChild.insertBefore(c,y.firstElementChild.lastElementChild)}y.setAttribute("data-rendered","")}for(const d in e){var r=e[d].guid.toString(),o=e[d].code.toString(),a=(e[d].dir.toString(),v.querySelector('[data-guid="'+r+'"]'));const u=a||document.createElement("tr");for(const m in h)if(m in h){var i=e[d][m],s=Object.keys(h).indexOf(m),s=u.children.item(s);const f=s??document.createElement("td");f.hasAttribute("data-rendered")?m in e[d]&&_(f,m,i):(_(f,m,i),f.setAttribute("data-rendered","")),s||u.append(f)}if(!a){if(n)for(const g of n.children)u.append(g.cloneNode(!0));const p=u.querySelector("span.action-edit > a");p.href+="?lang="+o,u.setAttribute("data-guid",r),u.setAttribute("data-href",p.href),u.onclick=S,v.append(u)}}n&&n.remove(),t.remove(),b.removeAttribute("data-loading"),b.classList.remove("placeholder"),b.setAttribute("data-rendered","")}(languages)),e.removeAttribute("hidden")}function edit_translate(e,t,n){const r=document.querySelector(".view-list"),o=r.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","edit-translate"),o.cloned=!0,document.body.insertBefore(o,r);const a=document.getElementById("edit-translate"),i=a.querySelector("h2"),p={ctx_name:"Context",msg_src:"Source",msg_tr:"Translation",msg_comment:"Disambigua",msg_extra:"Comment",status:"Status",notes:"Notes",revised:"Revised"};var s=n.split("=")[1];let l;n=s+"-tr";languages&&languages[s]&&(l=languages[s].dir,i.innerText="Edit "+languages[s].name,i.className="");const c=source_request("src"),d=source_request(n),g=a.querySelector("table"),h=g.querySelector("thead"),b=g.querySelector("tbody");function y(e,t,n){if("msg_tr"==t)if(e.querySelector("span")){const r=e.querySelector("span");r.innerText=n.toString()}else{const o=document.createElement("span");o.className="input inline-edit",o.contentEditable=!0,o.dir=l,e.append(o)}else n&&(e.innerText=n.toString())}var u=0;function m(e){console.log("load",u++,e);try{!function(e){const t=b.firstElementChild,n=b.querySelector("tr.placeholder");if(!h.hasAttribute("data-rendered")){for(const s in p){const l=document.createElement("th");l.innerText=p[s]??s,h.firstElementChild.insertBefore(l,h.firstElementChild.lastElementChild)}h.setAttribute("data-rendered","")}for(const c in e){var r=e[c].guid.toString(),o=b.querySelector('[data-guid="'+r+'"]');const d=o??document.createElement("tr");for(const u in p)if(u in p){var a=e[c][u],i=Object.keys(p).indexOf(u),i=d.children.item(i);const m=i??document.createElement("td");m.hasAttribute("data-rendered")?u in e[c]&&y(m,u,a):(y(m,u,a),m.setAttribute("data-rendered","")),i||d.append(m)}if(!o){if(n)for(const f of n.children)d.append(f.cloneNode(!0));d.setAttribute("data-guid",r),b.append(d)}}n&&n.remove(),t.remove(),g.removeAttribute("data-loading"),g.classList.remove("placeholder")}(JSON.parse(e.response))}catch(e){console.error("edit_translate()","load()",e),f(null,e)}}function f(e,t){console.error("edit_translate()","error()",e||"",t||"")}g.setAttribute("data-loading",""),c.then(function(e){m(e),d.then(m).catch(f)}).catch(f),a.removeAttribute("hidden")}function add_language(e,t,n){const r=document.querySelector(".view-edit"),o=r.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","add-language"),o.cloned=!0,document.body.insertBefore(o,r);const a=document.getElementById("add-language"),i=a.querySelector("h2"),c={lang_code:"ISO code (2)",lang_iso:"ISO code (2_2)",lang_dir:"Direction",lang_name:"Name",lang_tr_name:"Translated name",lang_numerus:"Numerus"};i.innerText="Add new language",i.className="";const d=a.querySelector("form"),u=d.firstElementChild;!function(t){const n=document.createElement("fieldset");for(const o in t){var r=t[o];const a=document.createElement("div"),i=document.createElement("label");let e;if(i.innerText=c[o]??o,r){if("object"==typeof r)if("select"==r.type){e=document.createElement("select");for(const s in r.options){const l=document.createElement("option");l.value=s,l.innerText=r.options[s],e.append(l)}}else"textarea"==r.type?e=document.createElement("textarea"):(e=document.createElement("input"),e.type=r.type)}else e=document.createElement("input"),e.setAttribute("type","text");a.append(i),a.append(e),n.append(a),d.insertBefore(n,u)}d.classList.remove("placeholder")}({lang_code:null,lang_iso:null,lang_dir:{type:"select",options:{ltr:"LTR (Left To Right)",rtl:"RTL (Right To Left)"}},lang_name:null,lang_tr_name:null,lang_numerus:{type:"number"}}),a.removeAttribute("hidden")}function api_request(e,t,n){const r=new XMLHttpRequest;let o=apipath+t;return"/"!=o.substr(-1)&&(o+="/"),n&&"get"===e&&(o+="?"+n,n=null),r.open(e,o),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.send(n),new Promise(function(e,t){r.onload=function(){e(r)},r.onerror=function(){t(r)}})}function source_request(e){const n=new XMLHttpRequest;e="e2se-ts-"+e+".json",e=sourcespath+"/"+e;return n.open("get",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(),new Promise(function(e,t){n.onload=function(){e(n)},n.onerror=function(){t(n)}})}function nav(e){const t=document.getElementById("nav").cloneNode(!0);function n(e){return e&&e.preventDefault(),route(this.href),!1}for(const r of t.querySelectorAll("a"))r.href=basepath+"/"+r.getAttribute("href"),r.onclick=n;if(t.removeAttribute("id"),t.removeAttribute("hidden"),navigation=t,e){const t=navigation.cloneNode(!0);e.replaceWith(navigation)}return navigation}function route(e,t){var n=document.querySelectorAll("main"),r=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(basepath))throw"Wrong base path";const o=e.replace(window.location.protocol+"//"+window.location.host,""),a=o.split("?");var i=a[0].split("/")[2],s=a[1]?a[1].split("&"):"",e=s[0]||"";console.info("route()",{path:a,uri:i,qs:s,key:"",value:e});for(const l of n)l.cloned&&l.remove(),l.setAttribute("hidden","");if(null!=i&&i in routes==!1)throw"Wrong URI Route";if(""in routes[i]==!1)throw"Wrong QueryString Route";if("function"!=typeof routes[i][""])throw"Callable Function";r&&window.history.pushState("",t,o),routes[i][""].call(this,i,"",e)}let languages,navigation;function init(){const e=source_request("langs");function t(e,t){console.error("init()","error()",e||"",t||"")}e.then(function(e){try{languages=JSON.parse(e.response),route()}catch(e){console.error("init()","load()",e),t(null,e)}}).catch(t),window.addEventListener("popstate",function(e){console.log("popState()",e),route()})}init();})()