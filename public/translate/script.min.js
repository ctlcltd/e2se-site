/*!
 * translate/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/translate",apipath="/api",sourcespath="/sources",routes={"":{"":main},"edit.html":{"":edit_translate},"add-language.html":{"":add_language}};function main(){document.title="E2SE Translations",document.querySelector('meta[name="description"]').setAttribute("content","Translation website for e2 SAT Editor");const e=document.getElementById("main"),h={locale:"Language",name:"Name",tr_name:"Translated name",completed:"Completed",revised:"Revised"},b=e.querySelector("table"),y=b.querySelector("thead"),S=b.querySelector("tbody");function E(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function w(e,t,n){if("completed"==t){if(!e.querySelector("span")){const o=document.createElement("span");o.className="level",o.title=n.toString()+"%",o.dataset.completed=n.toString(),e.append(o)}}else"revised"==t?e.innerText=n?"yes":"none":n&&(e.innerText=n.toString())}!b.hasAttribute("data-rendered")&&languages&&(b.setAttribute("data-loading",""),function(e){const t=S.firstElementChild,n=S.querySelector("tr.placeholder");if(!y.hasAttribute("data-rendered")){for(const l in h){const c=document.createElement("th");c.innerText=h[l]??l,y.firstElementChild.insertBefore(c,y.firstElementChild.lastElementChild)}y.setAttribute("data-rendered","")}for(const d in e){var o=e[d].guid.toString(),r=e[d].code.toString(),a=(e[d].dir.toString(),S.querySelector('[data-guid="'+o+'"]'));const u=a||document.createElement("tr");for(const m in h)if(m in h){var i=e[d][m],s=Object.keys(h).indexOf(m),s=u.children.item(s);const g=s??document.createElement("td");g.hasAttribute("data-rendered")?m in e[d]&&w(g,m,i):(w(g,m,i),g.setAttribute("data-rendered","")),s||u.append(g)}if(!a){if(n)for(const p of n.children)p!=n.firstElementChild&&u.append(p.cloneNode(!0));const f=u.querySelector("span.action-edit > a");f.href+="?lang="+r,u.setAttribute("data-guid",o),u.setAttribute("data-href",f.href),u.onclick=E,S.append(u)}}n&&n.remove(),t.remove(),b.removeAttribute("data-loading"),b.classList.remove("placeholder"),b.setAttribute("data-rendered","")}(languages)),e.removeAttribute("hidden")}function edit_translate(e,t,n){document.title="Edit - E2SE Translations",document.querySelector('meta[name="description"]').setAttribute("content","Edit translation strings of a language");const o=document.querySelector(".view-list"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","edit-translate"),r.cloned=!0,document.body.insertBefore(r,o);const a=document.getElementById("edit-translate"),i=a.querySelector("h2"),f={ctx_name:"Node",msg_src:"Source",msg_tr:"Translation",disambigua:"Disambigua",notes:"Notes",msg_extra:"Comment",msg_comment:"Context",status:"Status"};var s=n.split("=")[1];let p;n=s+"-tr";const l="tr-"+s;languages&&languages[s]&&(p=languages[s].dir,i.innerText="Edit "+languages[s].name,i.className="");let h=window.localStorage.getItem(l);try{h=h?JSON.parse(h):{}}catch(e){h={},m(null,e)}const c=source_request("src"),d=source_request(n);let b={};const y=a.querySelector("table"),S=y.querySelector("thead"),E=y.querySelector("tbody");function w(t,e,n){if("msg_tr"==e)if(t.querySelector("span")){var o=t.closest("[data-guid]").dataset.guid;const r=t.querySelector("span");h[o]?(r.srcText=n.toString(),r.innerText=h[o],r.dataset.changed=""):r.innerText=r.srcText=n.toString()}else{const a=document.createElement("span");a.className="input inline-edit",a.contentEditable="plaintext-only",a.dir=p,t.append(a)}else if("disambigua"==e){if(n&&"object"==typeof n&&0!=Object.keys(n).length){const i=document.createElement("button");i.className="toggler",i.type="button",i.innerText=Object.keys(n).length;const s=document.createElement("ul"),l=document.createElement("div");l.className="dropdown",l.setAttribute("hidden",""),l.append(s),t.append(i),t.append(l);for(const c of n){const d=b[c],u=document.createElement("li"),m=document.createElement("a");m.href="javascript:",m.innerText=d.toString(),m.setAttribute("data-scroll-row",d),u.append(m),s.append(u)}}}else if("status"==e)if(t.querySelector("span")){const g=t.querySelector("span");if(""!==n){let e;0==n?e="unfinished":1==n?e="completed":2==n&&(e="vanished"),g.className+=" status-"+e,g.innerText=e}}else{const f=document.createElement("span");f.className="status",t.append(f)}else if("msg_extra"==e){if(n){let e=n.toString();e=e.replace(" | ","\n"),t.innerText=e.toString()}}else n&&(t.innerText=n.toString())}function u(e){try{var t=JSON.parse(e.response);!function(e){if(0==Object.keys(b).length)for(const n in e){var t=e[n].guid;b[t]=n}}(t),function(e){const t=E.firstElementChild,n=E.querySelector("tr.placeholder");if(!S.hasAttribute("data-rendered")){for(const s in f){const l=document.createElement("th");l.innerText=f[s]??s,S.firstElementChild.insertBefore(l,S.firstElementChild.lastElementChild)}S.setAttribute("data-rendered","")}for(const c in e){var o=e[c].guid.toString(),r=E.querySelector('[data-guid="'+o+'"]');const d=r??document.createElement("tr");for(const u in f)if(u in f){var a=e[c][u],i=Object.keys(f).indexOf(u),i=d.children.item(i);const m=i??document.createElement("td");m.hasAttribute("data-rendered")?u in e[c]&&w(m,u,a):(w(m,u,a),m.setAttribute("data-rendered","")),i||d.append(m)}if(!r){if(n)for(const g of n.children)d.append(g.cloneNode(!0));d.setAttribute("data-guid",o),d.title=c,E.append(d)}}n&&n.remove(),t.remove(),y.removeAttribute("data-loading"),y.classList.remove("placeholder")}(t)}catch(e){m(null,e)}}function m(e,t){console.error("edit_translate()","error()",e||"",t||"")}y.setAttribute("data-loading",""),c.then(function(e){u(e),d.then(u).catch(m)}).catch(m),a.removeAttribute("hidden"),E.addEventListener("click",function(e){const t=e.target;t.classList.contains("toggler")?t.nextElementSibling.hasAttribute("hidden")?(t.nextElementSibling.removeAttribute("hidden"),t.classList.add("opened")):(t.nextElementSibling.setAttribute("hidden",""),t.classList.remove("opened"),window.setTimeout(function(){t.blur()},100)):document.querySelectorAll(".toggler").forEach(function(e){e.nextElementSibling.hasAttribute("hidden")||(e.nextElementSibling.setAttribute("hidden",""),e.classList.remove("opened"),window.setTimeout(function(){e.blur()},100))})}),E.addEventListener("click",function(e){const t=e.target;if(t.hasAttribute("data-scroll-row")){e=t.getAttribute("data-scroll-row"),e=parseInt(e)-1;const n=E.rows.item(e);e=(n.previousElementSibling||n).offsetTop;window.scrollTo(0,e),n.classList.add("highlight"),window.setTimeout(function(){n.classList.remove("highlight")},2e3)}}),E.addEventListener("input",function(e){const t=e.target;if(t.classList.contains("input")){var n=t.parentElement.closest("[data-guid]");console.log(e);try{var o=n.dataset.guid;""!=t.srcText&&t.srcText===t.textContent?delete h[o]:h[o]=t.textContent,console.log(h),window.localStorage.setItem(l,JSON.stringify(h))}catch(e){m(null,e)}}})}function add_language(e,t,n){document.title="Add language - E2SE Translations",document.querySelector('meta[name="description"]').setAttribute("content","Add a new language to translations");const o=document.querySelector(".view-edit"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","add-language"),r.cloned=!0,document.body.insertBefore(r,o);const a=document.getElementById("add-language"),i=a.querySelector("h2"),c={lang_code:"ISO 639-1 language code (eg. xz)",lang_locale:"Locale language code (eg. xz_XA)",lang_dir:"Direction",lang_name:"Name",lang_tr_name:"Translated name",lang_numerus:"Numerus"};i.innerText="Add new language",i.className="";const d=a.querySelector("form"),u=d.firstElementChild;!function(t){const n=document.createElement("fieldset");for(const r in t){var o=t[r];const a=document.createElement("div"),i=document.createElement("label");let e;if(i.innerText=c[r]??r,o){if("object"==typeof o)if("select"==o.type){e=document.createElement("select");for(const s in o.options){const l=document.createElement("option");l.value=s,l.innerText=o.options[s],e.append(l)}}else"textarea"==o.type?e=document.createElement("textarea"):(e=document.createElement("input"),e.type=o.type)}else e=document.createElement("input"),e.setAttribute("type","text");a.append(i),a.append(e),n.append(a),d.insertBefore(n,u)}d.classList.remove("placeholder")}({lang_code:null,lang_locale:null,lang_dir:{type:"select",options:{ltr:"LTR (Left To Right)",rtl:"RTL (Right To Left)"}},lang_name:null,lang_tr_name:null,lang_numerus:{type:"number"}}),a.removeAttribute("hidden")}function api_request(e,t,n){const o=new XMLHttpRequest;let r=apipath+t;return"/"!=r.substr(-1)&&(r+="/"),n&&"get"===e&&(r+="?"+n,n=null),o.open(e,r),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(n),new Promise(function(e,t){o.onload=function(){e(o)},o.onerror=function(){t(o)}})}function source_request(e){const n=new XMLHttpRequest;e="e2se-ts-"+e+".json",e=sourcespath+"/"+e;return n.open("get",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(),new Promise(function(e,t){n.onload=function(){e(n)},n.onerror=function(){t(n)}})}function route(e,t){var n=document.querySelectorAll("main"),o=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(basepath))throw"Wrong base path";const r=e.replace(window.location.protocol+"//"+window.location.host,""),a=r.split("?");var i=a[0].split("/")[2],s=a[1]?a[1].split("&"):"",e=s[0]||"";console.info("route()",{path:a,uri:i,qs:s,key:"",value:e});for(const l of n)l.cloned&&l.remove(),l.setAttribute("hidden","");if(null!=i&&i in routes==!1)throw"Wrong URI Route";if(""in routes[i]==!1)throw"Wrong QueryString Route";if("function"!=typeof routes[i][""])throw"Callable Function";o&&window.history.pushState("",t,r),routes[i][""].call(this,i,"",e)}var languages;function init(){const e=source_request("langs");function t(e,t){console.error("init()","error()",e||"",t||"")}!function(){var e=window.sessionStorage.getItem("preferred-color");if("light"==e||"dark"==e){document.body.setAttribute("data-color",e),"dark"==e?document.body.classList.add("dark"):document.body.classList.remove("dark");const t=document.getElementById("switch-color");t.innerText="switch to "+("light"==e?"dark":"light")}}(),document.getElementById("head").addEventListener("click",function(e){const t=e.target;if("switch-color"==t.id){let e=document.body.hasAttribute("data-color")?document.body.getAttribute("data-color"):"light";"light"==e?(e="dark",t.innerText="switch to light",document.body.setAttribute("data-color","dark"),document.body.classList.add("dark"),window.setTimeout(function(){t.blur()},100)):"dark"==e&&(e="light",t.innerText="switch to dark",document.body.setAttribute("data-color","light"),document.body.classList.remove("dark"),window.setTimeout(function(){t.blur()},100)),"light"!=e&&"dark"!=e||window.sessionStorage.setItem("preferred-color",e)}}),e.then(function(e){try{languages=JSON.parse(e.response),route()}catch(e){t(null,e)}}).catch(t),window.addEventListener("popstate",function(e){route()})}init();})()