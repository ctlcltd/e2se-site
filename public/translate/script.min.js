/*!
 * translate/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/translate",apipath="/api",sourcespath="/sources",routes={"":{"":main},"edit.html":{"":edit_translate},"add-language.html":{"":add_language}};function main(){console.log("main()"),document.title="E2SE Translations",document.querySelector('meta[name="description"]').setAttribute("content","Translation website for e2 SAT Editor");const e=document.getElementById("main"),y={locale:"Language",name:"Name",tr_name:"Translated name",completed:"Completed",revised:"Revised"},S=e.querySelector("table"),w=S.querySelector("thead"),E=S.querySelector("tbody");function A(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function v(e,t,n){if("completed"==t){if(!e.querySelector("span")){const o=document.createElement("span");o.className="level",o.title=n.toString()+"%",o.dataset.completed=n.toString(),o.style="--completed: "+n.toString()+"%;",e.append(o)}}else"revised"==t?e.innerText=n?"yes":"none":n&&(e.innerText=n.toString())}document.getElementById("ctrbar-add-language").removeAttribute("hidden"),document.getElementById("ctrbar-submit-form").setAttribute("hidden",""),document.querySelector(".submit-form").classList.add("placeholder"),!S.hasAttribute("data-rendered")&&languages&&(S.setAttribute("data-loading",""),function(e){const t=E.firstElementChild,n=E.querySelector("tr.placeholder");if(!w.hasAttribute("data-rendered")){for(const c in y){const u=document.createElement("th");u.innerText=y[c]??c,w.firstElementChild.insertBefore(u,w.firstElementChild.lastElementChild)}w.setAttribute("data-rendered","")}for(const m in e){var o=e[m].guid.toString(),r=e[m].code.toString(),a=e[m].type.toString(),i=e[m].dir.toString(),s=E.querySelector('[data-guid="'+o+'"]');const g=s||document.createElement("tr");for(const f in y)if(f in y){var d=e[m][f],l=Object.keys(y).indexOf(f),l=g.children.item(l);const p=l??document.createElement("td");p.hasAttribute("data-rendered")?f in e[m]&&v(p,f,d):(v(p,f,d),p.setAttribute("data-rendered","")),l||g.append(p)}if(!s){if(n)for(const b of n.children)b!=n.firstElementChild&&g.append(b.cloneNode(!0));const h=g.querySelector("span.action-edit > a");h.href+="?lang="+r,g.setAttribute("data-guid",o),g.setAttribute("data-type",a),g.setAttribute("data-dir",i),g.setAttribute("data-href",h.href),g.setAttribute("data-animated",""),g.onclick=A,E.append(g)}}n&&n.remove(),t.remove(),S.removeAttribute("data-loading"),S.classList.remove("placeholder"),S.setAttribute("data-rendered","")}(languages)),e.removeAttribute("hidden"),window.setTimeout(function(){!function(){for(var e=E.rows.length;e--;)E.rows.item(e).removeAttribute("data-animated"),E.rows.item(e).style="--delay: "+20*e+"ms;"}()},300)}function edit_translate(e,t,n){console.log("edit_translate()"),document.title="Edit - E2SE Translations",document.querySelector('meta[name="description"]').setAttribute("content","Edit translation strings of a language");const o=document.querySelector(".view-list"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","edit-translate"),r.cloned=!0,document.getElementById("page").insertBefore(r,o);const a=document.getElementById("edit-translate"),i=a.querySelector("h2"),f={ctx_name:"Node",msg_src:"Source",msg_tr:"Translation",disambigua:"Disambigua",notes:"Notes",msg_extra:"Comment",msg_comment:"Context",status:"Status"},p={0:"No translate",1:"Maybe wrong",2:"Maybe wrong",3:"Maybe wrong",6:"System string | Maybe wrong",8:"Conventional | Maybe wrong"},h=a.querySelector("table"),b=h.querySelector("thead"),y=h.querySelector("tbody");let S={};var s,d=n.split("=")[1];let w;var l=d+"-tr";const c="tr-"+d;languages&&languages[d]&&(s=languages[d].code.toString(),n=languages[d].type.toString(),w=languages[d].dir.toString(),i.innerText="Edit "+languages[d].name,i.className="",h.setAttribute("data-lang",s),h.setAttribute("data-type",n),h.setAttribute("data-dir",w));let E=window.localStorage.getItem(c);try{E=E?JSON.parse(E):{}}catch(e){E={},v(null,e)}const u=source_request("src"),m=source_request(l);function A(t,e,n){if("msg_tr"==e)if(t.querySelector("span")){var o=t.closest("[data-guid]").dataset.guid;const r=t.querySelector("span");E[o]?(r.srcText=n.toString(),r.innerText=E[o],r.dataset.changed=""):r.innerText=r.srcText=n.toString()}else{const a=document.createElement("span");a.className="input inline-edit",a.contentEditable="plaintext-only",a.dir=w,t.append(a)}else if("disambigua"==e){if(n&&"object"==typeof n&&0!=Object.keys(n).length){const i=document.createElement("button");i.className="toggler",i.type="button",i.innerText=Object.keys(n).length;const s=document.createElement("ul"),d=document.createElement("div");d.className="dropdown",d.setAttribute("hidden",""),d.append(s),t.append(i),t.append(d);for(const l of n){const c=S[l],u=document.createElement("li"),m=document.createElement("a");m.href="javascript:",m.innerText=c.toString(),m.setAttribute("data-scroll-row",c),u.append(m),s.append(u)}}}else if("status"==e)if(t.querySelector("span")){const g=t.querySelector("span");if(""!==n){let e;0==n?e="unfinished":1==n?e="completed":2==n&&(e="vanished"),g.className+=" status-"+e,g.innerText=e}}else{const f=document.createElement("span");f.className="status",t.append(f)}else if("msg_extra"==e){if(n){let e=n.toString();e=e.replace(" | ","\n"),t.innerText=e.toString()}}else"notes"==e?n&&(n in p?t.innerText=p[n].replace(" | ","\n"):t.innerText=n.toString()):n&&(t.innerText=n.toString())}function g(e){document.getElementById("ctrbar-add-language").setAttribute("hidden",""),document.getElementById("ctrbar-submit-form").removeAttribute("hidden"),document.querySelector(".submit-form").classList.remove("placeholder");try{var t=JSON.parse(e.response);!function(e){if(0==Object.keys(S).length)for(const n in e){var t=e[n].guid;S[t]=n}}(t),function(e){const t=y.firstElementChild,n=y.querySelector("tr.placeholder");if(!b.hasAttribute("data-rendered")){for(const s in f){const d=document.createElement("th");d.innerText=f[s]??s,b.firstElementChild.insertBefore(d,b.firstElementChild.lastElementChild)}b.setAttribute("data-rendered","")}for(const l in e){var o=e[l].guid.toString(),r=y.querySelector('[data-guid="'+o+'"]');const c=r??document.createElement("tr");for(const u in f)if(u in f){var a=e[l][u],i=Object.keys(f).indexOf(u),i=c.children.item(i);const m=i??document.createElement("td");m.hasAttribute("data-rendered")?u in e[l]&&A(m,u,a):(A(m,u,a),m.setAttribute("data-rendered","")),i||c.append(m)}if(!r){if(n)for(const g of n.children)c.append(g.cloneNode(!0));c.setAttribute("data-guid",o),c.title=l,y.append(c)}}n&&n.remove(),t.remove(),h.removeAttribute("data-loading"),h.classList.remove("placeholder")}(t)}catch(e){v(null,e)}}function v(e,t){console.error("edit_translate()","error()",e||"",t||"")}h.setAttribute("data-loading",""),u.then(function(e){g(e),m.then(g).catch(v)}).catch(v),a.removeAttribute("hidden"),y.addEventListener("click",function(e){const t=e.target;t.classList.contains("toggler")?t.nextElementSibling.hasAttribute("hidden")?(t.nextElementSibling.removeAttribute("hidden"),t.classList.add("opened")):(t.nextElementSibling.setAttribute("hidden",""),t.classList.remove("opened"),window.setTimeout(function(){t.blur()},100)):document.querySelectorAll(".toggler").forEach(function(e){e.nextElementSibling.hasAttribute("hidden")||(e.nextElementSibling.setAttribute("hidden",""),e.classList.remove("opened"),window.setTimeout(function(){e.blur()},100))})}),y.addEventListener("click",function(e){const t=e.target;if(t.hasAttribute("data-scroll-row")){e=t.getAttribute("data-scroll-row"),e=parseInt(e)-1;const n=y.rows.item(e);e=(n.previousElementSibling||n).offsetTop;window.scrollTo(0,e),n.classList.add("highlight"),window.setTimeout(function(){n.classList.remove("highlight")},2e3)}}),y.addEventListener("input",function(e){const t=e.target;if(t.classList.contains("input")){e=t.parentElement.closest("[data-guid]");try{var n=e.dataset.guid;""!=t.srcText&&t.srcText===t.textContent?delete E[n]:E[n]=t.textContent,window.localStorage.setItem(c,JSON.stringify(E))}catch(e){v(null,e)}}})}function add_language(e,t,n){console.log("add_language()"),document.title="Add language - E2SE Translations",document.querySelector('meta[name="description"]').setAttribute("content","Add a new language to translations");const o=document.querySelector(".view-edit"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","add-language"),r.cloned=!0,document.getElementById("page").insertBefore(r,o);const a=document.getElementById("add-language"),i=a.querySelector("h2"),l={lang_code:"ISO 639-1 language code (eg. xz)",lang_locale:"Locale language code (eg. xz_XA)",lang_dir:"Direction",lang_name:"Name",lang_tr_name:"Translated name",lang_numerus:"Numerus"};i.innerText="Add new language",i.className="";const c=a.querySelector("form"),u=c.firstElementChild;document.getElementById("ctrbar-add-language").setAttribute("hidden",""),document.getElementById("ctrbar-submit-form").setAttribute("hidden",""),document.querySelector(".submit-form").classList.add("placeholder"),function(t){const n=document.createElement("fieldset");for(const r in t){var o=t[r];const a=document.createElement("div"),i=document.createElement("label");let e;if(i.innerText=l[r]??r,o){if("object"==typeof o)if("select"==o.type){e=document.createElement("select");for(const s in o.options){const d=document.createElement("option");d.value=s,d.innerText=o.options[s],e.append(d)}}else"textarea"==o.type?e=document.createElement("textarea"):(e=document.createElement("input"),e.type=o.type)}else e=document.createElement("input"),e.setAttribute("type","text");a.append(i),a.append(e),n.append(a),c.insertBefore(n,u)}c.classList.remove("placeholder")}({lang_code:null,lang_locale:null,lang_dir:{type:"select",options:{ltr:"LTR (Left To Right)",rtl:"RTL (Right To Left)"}},lang_name:null,lang_tr_name:null,lang_numerus:{type:"number"}}),a.removeAttribute("hidden")}function styles(){var e=document.querySelectorAll(".what-this-area");if(e.length)for(const t of e)t.removeAttribute("hidden")}function token(){for(var e=10,n=[[48,57],[97,122],[65,90],[36,38,61,64]],o="";e--;){let e,t=Math.floor(4*Math.random());3==t&&100*Math.random()<50&&(t-=parseInt(3*Math.random())),e=3==t?(e=Math.floor(Math.random()*n[t].length),n[t][e]):Math.floor(Math.random()*(n[t][1]-n[t][0]+1)+n[t][0]),o+=String.fromCharCode(e)}return o}function api_request(e,t,n){const o=new XMLHttpRequest;let r=apipath+t;return"/"!=r.substr(-1)&&(r+="/"),n&&"get"===e&&(r+="?"+n,n=null),o.open(e,r),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(n),new Promise(function(e,t){o.onload=function(){e(o)},o.onerror=function(){t(o)}})}function source_request(e){const n=new XMLHttpRequest;e="e2se-ts-"+e+".json",e=sourcespath+"/"+e;return n.open("get",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(),new Promise(function(e,t){n.onload=function(){e(n)},n.onerror=function(){t(n)}})}function route(e,t){var n=document.querySelectorAll("main"),o=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(basepath))throw"Wrong base path";const r=e.replace(window.location.protocol+"//"+window.location.host,""),a=r.split("?");var i=a[0].split("/")[2],s=a[1]?a[1].split("&"):"",e=s[0]||"";console.info("route()",{path:a,uri:i,qs:s,key:"",value:e});for(const d of n)d.cloned&&d.remove(),d.setAttribute("hidden","");if(null!=i&&i in routes==!1)throw"Wrong URI Route";if(""in routes[i]==!1)throw"Wrong QueryString Route";if("function"!=typeof routes[i][""])throw"Callable Function";o&&window.history.pushState("",t,r),routes[i][""].call(this,i,"",e)}var languages;function init(){const e=source_request("langs");function t(e,t){console.error("init()","error()",e||"",t||"")}!function(){var e=window.localStorage.getItem("preferred-color");if("light"==e||"dark"==e){document.body.setAttribute("data-color",e),"dark"==e?document.body.classList.add("dark"):document.body.classList.remove("dark");const t=document.getElementById("switch-color");t.innerText="switch to "+("light"==e?"dark":"light")}}(),document.getElementById("head").addEventListener("click",function(e){const t=e.target;if("switch-color"==t.id){let e=document.body.hasAttribute("data-color")?document.body.getAttribute("data-color"):"light";"light"==e?(e="dark",t.innerText="switch to light",document.body.setAttribute("data-color","dark"),document.body.classList.add("dark"),window.setTimeout(function(){t.blur()},100)):"dark"==e&&(e="light",t.innerText="switch to dark",document.body.setAttribute("data-color","light"),document.body.classList.remove("dark"),window.setTimeout(function(){t.blur()},100)),"light"!=e&&"dark"!=e||window.localStorage.setItem("preferred-color",e)}}),e.then(function(e){try{languages=JSON.parse(e.response),route()}catch(e){t(null,e)}}).catch(t),window.addEventListener("popstate",function(e){route()})}styles(),window.token=token,init();})()