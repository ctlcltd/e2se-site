/*!
 * backend/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/backend",apipath="/api",sourcespath="/sources",routes={"":{"":main},service:{"":service},inspect:{"":list,add:edit,edit:edit},test:{"":api_test},login:{"":signin},logout:{"":signout}};function main(){const e=document.getElementById("main");nav(e.querySelector(".nav")),e.removeAttribute("hidden")}function list(e,t,n){const p=document,r=p.querySelector(".view-list"),o=r.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","view-list"),o.cloned=!0,p.body.insertBefore(o,r);const i=p.getElementById("view-list");var a=i.querySelector(".nav.placeholder");const s=i.querySelector("h2");nav(a),s.innerText=e+" list",s.className="";const c=api_request("get",e),v=i.querySelector("table"),h=v.querySelector("thead"),m=v.querySelector("tbody");function g(e){return e.preventDefault(),!e.target.parentElement.classList.contains("action-edit")&&"SPAN"!=e.target.tagName||route(this.dataset.href),!1}function y(e){return e.preventDefault(),window.confirm("Are you sure to delete this item?")&&route(this.href),!1}function l(e){console.warn(e)}c.then(function(e){try{var t=JSON.parse(e.response);if(!t.status)return l(e);t.data&&function(e){var t=0;let n;const r=m.firstElementChild;for(const i in e){const a=r.cloneNode(!0);var o=a.firstElementChild;const s=a.querySelector("span.action-edit > a"),c=a.querySelector("span.action-delete > a");for(const l in e[i]){const u=e[i][l];if(n||-1==l.indexOf("_id")||(n="&"+l+"="+u.toString()),0===t){const f=p.createElement("th");f.innerText=l,h.firstElementChild.insertBefore(f,h.firstElementChild.lastElementChild)}const d=p.createElement("td");d.innerText=u?u.toString():"",a.insertBefore(d,o)}s.href+=n,c.href+=n,c.onclick=y,a.setAttribute("data-href",s.href),a.onclick=g,m.prepend(a),t++}r.remove(),v.classList.remove("placeholder")}(t.data)}catch(e){console.error("loader",e)}}).catch(l),i.removeAttribute("hidden")}function edit(e,t,n){const s=document,r=s.querySelector(".view-edit"),o=r.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","view-edit"),o.cloned=!0,s.body.insertBefore(o,r);const i=s.getElementById("view-edit");var a=i.querySelector(".nav.placeholder");const c=i.querySelector("h2");nav(a),c.innerText=e+" edit",c.className="";const l=api_request(method,e,n),u=i.querySelector("form"),d=u.firstElementChild;function f(e){console.warn(e)}l.then(function(e){try{var t=JSON.parse(e.response);if(!t.status)return f(e);t.data&&function(e){const t=s.createElement("fieldset");for(const n in e){const r=e[n],o=s.createElement("div"),i=s.createElement("label"),a=s.createElement("input");i.innerText=n,a.setAttribute("type","text"),a.value=r?r.toString():"",o.append(i),o.append(a),t.append(o),u.insertBefore(t,d)}u.classList.remove("placeholder")}(t.data)}catch(e){console.error("loader",e)}}).catch(f),i.removeAttribute("hidden")}function service(e,t,n){const l=document,r=l.querySelector(".view-service"),o=r.cloneNode(!0);o.removeAttribute("class"),o.setAttribute("id","view-list"),o.cloned=!0,l.body.insertBefore(o,r);const i=l.getElementById("view-list");var a=i.querySelector(".nav.placeholder");const s=i.querySelector("h2");nav(a),s.className="";const c=api_request("get",e),u=i.querySelector("table"),d=u.querySelector("thead"),f=u.querySelector("tbody");function p(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function v(e,t){console.warn(e)}c.then(function(e){try{var t=JSON.parse(e.response);if(!t.status)return v(e);t.data&&function(e){var t=0;let n;d.firstElementChild.remove(),f.firstElementChild.remove();for(const r in e){const o=l.createElement("tr");for(const i in e[r]){const a=e[r][i];if(0==t){const c=l.createElement("th");c.innerText=i,d.firstElementChild.insertBefore(c,d.firstElementChild.lastElementChild)}const s=l.createElement("td");s.innerText=a?a.toString():"",o.insertBefore(s,o.lastElementChild),n="?row="+a}o.setAttribute("data-href",n),o.onclick=p,f.append(o),t++}u.classList.remove("placeholder")}(t.data)}catch(e){console.error("loader",e)}}).catch(v),i.removeAttribute("hidden")}function signin(){const t=document,n=t.getElementById("signin"),o=t.getElementById("sign_login"),i=o.querySelector(".placeholder").cloneNode(),r=3;let a=0,s=null;function c(e){s=t.createElement("div"),s.className="error",s.innerText=e,o.querySelector(".placeholder").replaceWith(s)}function l(e){o.reset();try{var t=JSON.parse(e.response);if(t.status&&t.data)return o.removeAttribute("disabled"),o.removeAttribute("data-loading"),n.setAttribute("hidden",""),sessionStorage.setItem("backend",(new Date).toJSON()),route(basepath+"/");a++<r&&o.removeAttribute("disabled"),c("Wrong credentials.")}catch(e){o.removeAttribute("data-loading"),o.reset(),c("An error occurred."),console.error("loader",e)}}function u(e){o.reset(),console.warn(e)}sessionStorage.clear(),o.addEventListener("submit",function(e){e.preventDefault(),o.setAttribute("disabled",""),o.setAttribute("data-loading",""),s&&s.replaceWith(i);let t=[];for(const r of this.elements)"FIELDSET"==r.tagName||"BUTTON"==r.tagName||r.type&&"button"===r.type||t.push(r.name+"="+r.value);if(!t.length)return o.removeAttribute("disabled"),o.removeAttribute("data-loading"),o.reset(),c("Please enter your credentials.");t=t.join("&");const n=api_request("post","login","",t);n.then(l).catch(u)}),n.removeAttribute("hidden")}function signout(){return sessionStorage.clear(),route(basepath+"/?login")}function api_request(e,t,n,r){const o=new XMLHttpRequest;let i=apipath+"/",a=null;if("get"===e)t&&(i+="?data="+t),n&&(i+=t?"&":"?&call="+n),r&&(i+=t||n?"&":"?"+r);else{if("post"!==e)return new Promise(function(e,t){t("Request Error")});a="body="+t,n&&(a+="&call="+n),r&&(a+="&"+r)}return o.open(e,i),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(a),new Promise(function(e,t){o.onload=function(){e(o)},o.onerror=function(){t(o)}})}function api_test(){const a=document,s=a.getElementById("api-test");var e=s.querySelector(".nav");const t=a.getElementById("api_request"),n=a.getElementById("api_response"),c=["get","post"],r=api_request("get"),l=t.querySelector('[name="endpoint"]'),u=t.querySelector('[name="method"]'),o=t.querySelector('[name="route"]'),i=t.querySelector('[name="body"]'),d=n.querySelector('[name="response-status"]'),f=n.querySelector('[name="response-body"]'),p=n.querySelector('[name="response-headers"]');function v(){try{if(!apiroutes)return!1;var e=l.value;o.innerHTML="";for(const t in apiroutes[e]){const n=a.createElement("option");n.value=t,n.innerText=t,o.appendChild(n)}}catch(e){console.error("endpointChange",e)}}function h(e){e&&e.preventDefault(),i.value="",o.value="",l.value=l.options[0].value,v(),u.value=u.options[0].value,o.value=o.options[0].value}function m(e){n.removeAttribute("data-loading"),d.value=e.status,f.value=e.response,p.value=e.getAllResponseHeaders()}function g(e){console.warn(e)}nav(e),t.addEventListener("submit",function(e){e.preventDefault();const t=api_request(u.value,l.value,o.value,i.value);n.setAttribute("data-loading",""),t.then(m).catch(m)}),t.addEventListener("reset",h),l.addEventListener("change",v),s.hasAttribute("data-render")?apiroutes&&(s.removeAttribute("hidden"),h()):r.then(function(e){try{s.removeAttribute("hidden");var t=JSON.parse(e.response);if(!t.status)return g(e);apiroutes=t.data;for(const n of c){const r=a.createElement("option");r.value=n,r.innerText=n.toUpperCase(),u.appendChild(r)}for(const o in t.data){const i=a.createElement("option");i.value=o,i.innerText=o,l.appendChild(i)}s.setAttribute("data-render",""),v()}catch(e){console.error("loader",e)}}).catch(g)}function nav(e){const t=document.getElementById("nav").cloneNode(!0);function n(e){return e.preventDefault(),route(this.href),!1}for(const r of t.querySelectorAll("a"))r.href=basepath+"/"+r.getAttribute("href"),r.onclick=n;if(t.removeAttribute("id"),t.removeAttribute("hidden"),navigation=t,e){const t=navigation.cloneNode(!0);e.replaceWith(navigation)}return navigation}function route(e,t){var n=document.querySelectorAll("main"),r=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(basepath))throw"Wrong base path";const o=e.replace(window.location.protocol+"//"+window.location.host,""),i=o.split("?");var a=i[1]&&0==/&/.test(i[1])?i[1].split("&")[0]:"",s=i[1]?i[1].split("&"):"",c=s[1]&&s[1]!=a?s[1]:"",e=s[2]&&s[1]!=a?s[2]:"";console.info("route()",{path:i,uri:a,qs:s,key:c,value:e});for(const l of n)l.cloned&&l.remove(),l.setAttribute("hidden","");if(null!=a&&a in routes==!1)throw"Wrong URI Route";if(null!=c&&c in routes[a]==!1)throw"Wrong QueryString Route";if("function"!=typeof routes[a][c])throw"Callable Function";r&&window.history.pushState("",t,o),routes[a][c].call(this,a,c,e)}var apiroutes,navigation;function init(){try{if(sessionStorage.setItem("_test","1"),!sessionStorage.getItem("_test"))throw"Storage Error";sessionStorage.removeItem("_test")}catch(e){console.error(e)}sessionStorage.getItem("backend")?(nav(),route()):signin(),window.addEventListener("popstate",function(e){route()})}init();})()