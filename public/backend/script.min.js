/*!
 * backend/script.js
 * 
 * @author Leonardo Laureti
 * @license MIT License
 */
(function(){const basepath="/backend",apipath="/api",sourcespath="/sources",routes={"":{"":main},service:{"":service},inspect:{"":list,add:edit,edit:edit},test:{"":api_test},login:{"":signin},logout:{"":signout}};function main(){const e=document.getElementById("main");nav(e.querySelector(".nav")),e.removeAttribute("hidden")}function list(e,t,n){const o=document.querySelector(".view-list"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-list"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-list");var a=i.querySelector(".nav.placeholder");const s=i.querySelector("h2");nav(a),s.innerText=e+" list",s.className="";const c=api_request("get",e),p=i.querySelector("table"),f=p.querySelector("thead"),h=p.querySelector("tbody");function v(e){return e&&e.preventDefault(),!e.target.parentElement.classList.contains("action-edit")&&"SPAN"!=e.target.tagName||route(this.dataset.href),!1}function g(e){return e&&e.preventDefault(),window.confirm("Are you sure to delete this item?")&&route(this.href),!1}function l(e,t){console.error("list()","error()",e||"",t||"")}c.then(function(e){try{var t=JSON.parse(e.response);if(!t.status)return l(t.data);t.data&&function(e){var t=0;let n;const o=h.firstElementChild;for(const i in e){const a=o.cloneNode(!0);var r=a.firstElementChild;const s=a.querySelector("span.action-edit > a"),c=a.querySelector("span.action-delete > a");for(const l in e[i]){const u=e[i][l];if(n||-1==l.indexOf("_id")||(n="&"+l+"="+u.toString()),0===t){const m=document.createElement("th");m.innerText=l,f.firstElementChild.insertBefore(m,f.firstElementChild.lastElementChild)}const d=document.createElement("td");d.innerText=u?u.toString():"",a.insertBefore(d,r)}s.href+=n,c.href+=n,c.onclick=g,a.setAttribute("data-href",s.href),a.onclick=v,h.prepend(a),t++}o.remove(),p.classList.remove("placeholder")}(t.data)}catch(e){console.error("list()","load()",e),l(null,e)}}).catch(l),i.removeAttribute("hidden")}function edit(e,t,n){const o=document.querySelector(".view-edit"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-edit"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-edit");var a=i.querySelector(".nav.placeholder");const s=i.querySelector("h2");nav(a),s.innerText=e+" edit",s.className="";const c=api_request(method,e,n),l=i.querySelector("form"),u=l.firstElementChild;function d(e,t){console.error("edit()","error()",e||"",t||"")}c.then(function(e){try{var t=JSON.parse(e.response);if(!t.status)return d(t.data);t.data&&function(e){const t=document.createElement("fieldset");for(const n in e){const o=e[n],r=document.createElement("div"),i=document.createElement("label"),a=document.createElement("input");i.innerText=n,a.setAttribute("type","text"),a.value=o?o.toString():"",r.append(i),r.append(a),t.append(r),l.insertBefore(t,u)}l.classList.remove("placeholder")}(t.data)}catch(e){console.error("edit()","load()",e),d(!1,e)}}).catch(d),i.removeAttribute("hidden")}function service(e,t,n){const o=document.querySelector(".view-service"),r=o.cloneNode(!0);r.removeAttribute("class"),r.setAttribute("id","view-list"),r.cloned=!0,document.body.insertBefore(r,o);const i=document.getElementById("view-list");var a=i.querySelector(".nav.placeholder");const s=i.querySelector("h2");nav(a),s.className="";const c=api_request("get",e),l=i.querySelector("table"),u=l.querySelector("thead"),d=l.querySelector("tbody");function m(e){return e&&e.preventDefault(),route(this.dataset.href),!1}function p(e,t){console.error("service()","error()",e||"",t||"")}c.then(function(e){try{var t=JSON.parse(e.response);if(!t.status)return p(t.data);t.data&&function(e){var t=0;let n;u.firstElementChild.remove(),d.firstElementChild.remove();for(const o in e){const r=document.createElement("tr");for(const i in e[o]){const a=e[o][i];if(0==t){const c=document.createElement("th");c.innerText=i,u.firstElementChild.insertBefore(c,u.firstElementChild.lastElementChild)}const s=document.createElement("td");s.innerText=a?a.toString():"",r.insertBefore(s,r.lastElementChild),n="?row="+a}r.setAttribute("data-href",n),r.onclick=m,d.append(r),t++}l.classList.remove("placeholder")}(t.data)}catch(e){console.error("service()","load()",e),p(null,e)}}).catch(p),i.removeAttribute("hidden")}function signin(){const r=document.getElementById("signin"),i=document.getElementById("sign_login"),a=i.querySelector(".placeholder").cloneNode(),s=3;let c=0,l=null;function u(t){i.reset();try{var e=JSON.parse(t.response);if(e.status&&e.data){i.removeAttribute("disabled"),i.removeAttribute("data-loading"),r.setAttribute("hidden","");var n="path="+basepath+"; ",o="expires="+new Date((new Date).getTime()+864e5).toGMTString()+"; ";return console.log("signin()","next()","backend-sign=1; "+n+o+"samesite=strict"),document.cookie="backend-sign=1; "+n+o+"samesite=strict",route(basepath+"/")}throw c++<s&&i.removeAttribute("disabled"),"Wrong credentials."}catch(e){i.removeAttribute("data-loading"),d(t,e)}}function d(e,t){i.reset(),e&&!t&&e.status&&(t="An error occurred."),l=document.createElement("div"),l.className="error",l.innerText=t,i.querySelector(".placeholder").replaceWith(l),console.error("signin()","error()",t)}document.cookie="backend-sign=; expires="+new Date(0).toGMTString()+", samesite=strict",i.addEventListener("submit",function(e){e&&e.preventDefault(),i.setAttribute("disabled",""),i.setAttribute("data-loading",""),l&&l.replaceWith(a);let t=[];for(const o of this.elements)"FIELDSET"==o.tagName||"BUTTON"==o.tagName||o.type&&"button"===o.type||t.push(o.name+"="+o.value);if(!t.length)return i.removeAttribute("disabled"),i.removeAttribute("data-loading"),d(null,"Please enter your credentials.");t=t.join("&");const n=api_request("post","",t);n.then(u).catch(d)}),r.removeAttribute("hidden")}function signout(){return route(basepath+"/?login")}function api_request(e,t,n){const o=new XMLHttpRequest;let r=apipath+"/"+(t?"?body="+t:"");return n&&"get"===e&&(r+="&"+n,n=null),o.open(e,r),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(n),new Promise(function(e,t){o.onload=function(){e(o)},o.onerror=function(){t(o)}})}function api_test(){const r=document.getElementById("api-test");var e=r.querySelector(".nav");const t=document.getElementById("api_request"),n=document.getElementById("api_response"),i=["get","post"],o=api_request("get","",""),a=t.querySelector('[name="endpoint"]'),s=t.querySelector('[name="method"]'),c=t.querySelector('[name="route"]'),l=t.querySelector('[name="body"]'),u=n.querySelector('[name="response-status"]'),d=n.querySelector('[name="response-body"]'),m=n.querySelector('[name="response-headers"]');function p(e){console.log("api_test()","response()",e),n.removeAttribute("data-loading"),u.value=e.status,d.value=e.response,m.value=e.getAllResponseHeaders()}function f(){return r.setAttribute("hidden",""),route(basepath+"/?login")}function h(e){e&&e.preventDefault(),l.value="",c.value="",a.value=a.options[0].value,v(),s.value=s.options[0].value,c.value=c.options[0].value}function v(){try{if(!apiroutes)throw 0;var e=a.value;c.innerHTML="";for(const t in apiroutes[e]){let e;e=document.createElement("option"),e.value=t,e.innerText=t,c.appendChild(e)}}catch(e){console.error("api_test()","endpointChange()",e)}}nav(e),t.addEventListener("submit",function(e){e&&e.preventDefault();const t=api_request(s.value,a.value,l.value);n.setAttribute("data-loading",""),t.then(p).catch(p)}),t.addEventListener("reset",h),a.addEventListener("change",v),r.hasAttribute("data-render")?function(){if(console.log("api_test()","resume()"),!apiroutes)throw 0;r.removeAttribute("hidden"),h()}():o.then(function(e){console.log("api_test()","load()",e);try{r.removeAttribute("hidden");var t=JSON.parse(e.response);if(!t.status)return f();apiroutes=t.data;for(const n of i){let e;e=document.createElement("option"),e.value=n,e.innerText=n.toUpperCase(),s.appendChild(e)}for(const o in t.data){let e;e=document.createElement("option"),e.value=o,e.innerText=o,a.appendChild(e)}r.setAttribute("data-render",!0),v()}catch(e){console.error("api_test()","load()",e)}}).catch(f)}function nav(e){const t=document.getElementById("nav").cloneNode(!0);function n(e){return e&&e.preventDefault(),route(this.href),!1}for(const o of t.querySelectorAll("a"))o.href=basepath+"/"+o.getAttribute("href"),o.onclick=n;if(t.removeAttribute("id"),t.removeAttribute("hidden"),navigation=t,e){const t=navigation.cloneNode(!0);e.replaceWith(navigation)}return navigation}function route(e,t){var n=document.querySelectorAll("main"),o=!!e;if(e=e||window.location.href,t=t||document.title,-1===e.indexOf(basepath))throw"Wrong base path";const r=e.replace(window.location.protocol+"//"+window.location.host,""),i=r.split("?");var a=i[1]&&0==/&/.test(i[1])?i[1].split("&")[0]:"",s=i[1]?i[1].split("&"):"",c=s[1]&&s[1]!=a?s[1]:"",e=s[2]&&s[1]!=a?s[2]:"";console.info("route()",{path:i,uri:a,qs:s,key:c,value:e});for(const l of n)l.cloned&&l.remove(),l.setAttribute("hidden","");if(null!=a&&a in routes==!1)throw"Wrong URI Route";if(null!=c&&c in routes[a]==!1)throw"Wrong QueryString Route";if("function"!=typeof routes[a][c])throw"Callable Function";o&&window.history.pushState("",t,r),routes[a][c].call(this,a,c,e)}let apiroutes,navigation;function init(){var e="path="+basepath+"; ",t="expires="+new Date((new Date).getTime()+6e4).toGMTString()+"; ";document.cookie="backend-test=1; "+e+t+"samesite=strict",-1!=document.cookie.indexOf("backend-test")&&(-1!=document.cookie.indexOf("backend-sign")?(nav(),route()):signin(),window.addEventListener("popstate",function(e){route()}))}init();})()